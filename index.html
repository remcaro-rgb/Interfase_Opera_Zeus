<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interfaz Opera - Zeus</title>
  <style>
    body {margin: 0; font-family: Arial, sans-serif; background-color: #0f172a; color: #e5e7eb; display: flex;}
    .sidebar {width: 260px; background-color: #111827; border-right: 1px solid #1f2937; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; padding-top: 24px;}
    .sidebar h2 {color: #22c55e; font-size: 18px; margin: 0 0 20px 20px;}
    .menu-item {padding: 12px 20px; color: #94a3b8; text-decoration: none; display: block; transition: background 0.2s; cursor: pointer;}
    .menu-item:hover, .menu-item.active {background-color: #1e293b; color: #22c55e;}
    .content {margin-left: 260px; padding: 20px; width: calc(100% - 260px);}    
    .card {background: #111827; padding: 20px; border-radius: 10px; border: 1px solid #1f2937; margin-bottom: 20px;}
    input, button {border-radius: 6px; border: none; padding: 8px 10px; margin: 5px 0; font-size: 14px;}
    input {width: 100%;}
    button {background-color: #22c55e; color: white; cursor: pointer;}
    button:hover {background-color: #16a34a;}
    table {width: 100%; border-collapse: collapse; color: #e5e7eb; margin-top: 10px;}
    table th, table td {border: 1px solid #1f2937; padding: 8px;}
    table th {background-color: #1e293b;}
    .hidden {display: none;}
    .editable:focus {outline: 2px solid #38bdf8;}
    .drop-zone {margin-top:10px;border:2px dashed #334155;border-radius:10px;padding:20px;text-align:center;color:#94a3b8;background-color:#1e293b;cursor:pointer;}
    .drop-zone.dragover {background-color:#334155;color:#fff;}
  </style>
  <!-- Supabase CDN (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- SheetJS para exportar .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Men√∫</h2>
    <div class="menu-item" data-section="usuarios" style="display:none">Usuarios</div>
    <div class="menu-item" data-section="clientes" style="display:none">Configuraci√≥n de Clientes</div>
    <div class="menu-item" data-section="configgeneral">Configuracion General</div>
    <div class="menu-item" data-section="cuentas">Configuraci√≥n de Cuentas Contables</div>
    <div class="menu-item" data-section="articulos">Configuraci√≥n de Art√≠culos</div>
    <div class="menu-item" data-section="ventas" style="display:none">Contabilizar Ventas</div>
    <div class="menu-item" data-section="contabilizacion">Contabilizaci√≥n</div>
    <div class="menu-item" data-section="inventario" style="display:none">Actualizar Inventario</div>
    <div class="menu-item" data-section="login" style="display:none">Iniciar Sesi√≥n</div>
  </div>

  <div class="content">
    <h1>Interfaz Opera - Zeus v1.10</h1>

    <!-- Configuraci√≥n General -->
<section id="configgeneral" class="card hidden">
  <h2>Configuraci√≥n General</h2>

  <div style="display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:center;">
    <label for="inpCuentaHuespedes" style="color:#94a3b8;">Cuenta Saldo Hu√©spedes en Casa</label>
    <input id="inpCuentaHuespedes" type="text" inputmode="numeric" placeholder="S√≥lo n√∫meros" />

    <label for="inpCodVendedor" style="color:#94a3b8;">C√≥digo de vendedor por defecto para clientes</label>
    <input id="inpCodVendedor" type="text" placeholder="Alfanum√©rico" />

    <label for="inpCuentaPorCobrar" style="color:#94a3b8;">Cuenta por cobrar por defecto para clientes</label>
    <input id="inpCuentaPorCobrar" type="text" inputmode="numeric" placeholder="S√≥lo n√∫meros" />
  </div>

  <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
    <button id="generalSave" type="button">Guardar</button>
    <span id="generalStatus" style="margin-left:6px;color:#94a3b8"></span>
  </div>

  <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
    <strong>√öltima actualizaci√≥n:</strong>
    <span id="generalLastUpdated">(sin publicar)</span>
  </div>
</section>


    <!-- Cuentas Contables -->
    <section id="cuentas" class="card hidden">
      <h2>Configuraci√≥n de Cuentas Contables</h2>

      <div style="overflow:auto">
        <table id="cuentasTable">
          <thead>
            <tr>
              <th>Codigo de Concepto Opera</th>
              <th>Nombre Concepto Opera</th>
              <th>Cuenta Contable Zeus</th>
              <th>Centro de costo</th>
              <th>BU</th>
              <th>Libro</th>
              <th>Auxiliar Abierto</th>
              <th>Moneda</th>
              <th>Banco</th>
              <th>Plaza</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="cuentasAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="cuentasSave" type="button">Guardar</button>
        <span id="cuentasStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>

      <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
        <strong>√öltima actualizaci√≥n global:</strong>
        <span id="cuentasLastUpdated">(sin publicar)</span>
      </div>
    </section>

    <!-- Contabilizaci√≥n (TSV / TXT) -->
    <section id="contabilizacion" class="card hidden">
      <h2>Contabilizaci√≥n</h2>
      <div class="note" style="color:#94a3b8;margin-bottom:8px">
        Carga un archivo de texto (tab separado) tipo "Cargos_Diarios_Opera.txt" para previsualizarlo.
      </div>

      <div class="row" style="display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;">
        <label for="contabFile" style="color:#94a3b8">Archivo Contabilizaci√≥n</label>
        <input id="contabFile" type="file" accept=".txt,.tsv,.csv" />
      </div>

      <div id="contabDropZone" class="drop-zone">
        Arrastra y suelta el archivo aqu√≠<br/>
        <small style="color:#64748b">o haz clic para seleccionar</small>
      </div>

      <!-- Filtros Contabilizaci√≥n -->
<div id="contabFilters" style="display:grid;grid-template-columns:repeat(6,minmax(140px,1fr));gap:8px;align-items:end;margin-top:12px;">
  <div>
    <label style="font-size:12px;color:#94a3b8">Fecha desde (YYYYMMDD)</label>
    <input id="contabDateFrom" type="text" placeholder="YYYYMMDD" />
  </div>
  <div>
    <label style="font-size:12px;color:#94a3b8">Fecha hasta (YYYYMMDD)</label>
    <input id="contabDateTo" type="text" placeholder="YYYYMMDD" />
  </div>
  <div>
    <label style="font-size:12px;color:#94a3b8">Monto m√≠n.</label>
    <input id="contabMontoMin" type="text" placeholder="0" />
  </div>
  <div>
    <label style="font-size:12px;color:#94a3b8">Monto m√°x.</label>
    <input id="contabMontoMax" type="text" placeholder="‚àû" />
  </div>
  <div style="grid-column: span 2;">
    <label style="font-size:12px;color:#94a3b8">Buscar texto (cualquier columna)</label>
    <input id="contabTextSearch" type="text" placeholder="Nombre, ciudad, email, etc." />
  </div>
</div>

<div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
  <button id="contabExportXLS" type="button">Exportar Excel</button>
  <span id="contabTotals" style="margin-left:6px;color:#94a3b8"></span>
</div>

      
      <div style="margin-top:12px;border-radius:12px;overflow-x:auto;border:1px solid #1f2937;">
        <table id="contabTable" style="min-width:800px;">
          <thead id="contabHead"></thead>
          <tbody id="contabBody"></tbody>
        </table>
      </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
      <button id="contabGenerate" type="button">Generar Archivo Contabilizacion Zeus</button>
      <button id="contabGenerateTerceros" type="button" style="background:#0ea5e9">Generar Archivo Terceros Zeus</button>
      <span id="contabStatus" style="margin-left:6px;color:#94a3b8"></span>
    </div>

    </section>

    <!-- Art√≠culos -->
    <section id="articulos" class="card hidden">
      <h2>Configuraci√≥n de Art√≠culos</h2>
      <div style="overflow:auto">
        <table id="articulosTable">
          <thead>
            <tr>
              <th>Codigo de producto Simphony</th>
              <th>Nombre de producto Simphony</th>
              <th>Codigo de articulo Zeus</th>
              <th>Centro de Costo Zeus</th>
              <th>Codigo Bodega Zeus</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="articulosAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="articulosSave" type="button">Guardar</button>
        <span id="articulosStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>
    </section>
  </div>

  <script>
  // === Supabase access helpers ===
  // Guardamos TODA la tabla de cuentas contables en UNA sola fila
  // en la tabla 'contabilidad_cuentas' con id = 1.
  // Estructura esperada en Supabase (Postgres):
  //   CREATE TABLE public.contabilidad_cuentas (
  //     id integer primary key,
  //     updated_at timestamptz,
  //     rows jsonb
  //   );

  let supa = null;
  // === HARDCODED SUPABASE CREDENTIALS ===
  const SUPABASE_URL  = "https://veztzwgrblvdpuzdhtor.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlenR6d2dyYmx2ZHB1emRodG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjY4MTcsImV4cCI6MjA3NzYwMjgxN30.2XaJ5YQQEZmihJF7zFEGv1QJ-z7RmAcPIHf4Hl1qnHk";

  async function initSupabaseIfNeeded(){
    if (supa) return supa;

    // 1) Si ya hay un cliente global, √∫salo
    if (window.supabaseClient) {
      supa = window.supabaseClient;
      return supa;
    }

    // 2) Crear cliente con credenciales hardcodeadas
    if (typeof window.supabase !== 'undefined'){
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      supa = window.supabaseClient;
      return supa;
    }

    console.warn('Supabase SDK no detectado o falta configuraci√≥n.');
    throw new Error('Supabase SDK no inicializado');
  }

  async function saveCuentasToSupabase(rows){
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('contabilidad_cuentas').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadCuentasFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('contabilidad_cuentas')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para ART√çCULOS ===
  async function saveArticulosToSupabase(rows){
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('articulos_config').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadArticulosFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('articulos_config')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error;
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para CONFIGURACI√ìN GENERAL ===
async function saveGeneralToSupabase(data){
  const client = await initSupabaseIfNeeded();
  const nowIso = new Date().toISOString();
  const payload = [{ id: 1, updated_at: nowIso, data }];
  const { error } = await client.from('config_general').upsert(payload, { onConflict: 'id' });
  if (error) throw error;
  return { updated_at: nowIso };
}

async function loadGeneralFromSupabase(){
  const client = await initSupabaseIfNeeded();
  const { data, error } = await client
    .from('config_general')
    .select('data, updated_at')
    .eq('id', 1)
    .maybeSingle();
  if (error && error.code !== 'PGRST116') throw error;
  if (!data) return { data: null, updated_at: null };
  return { data: data.data || null, updated_at: data.updated_at || null };
}

function parseToNumber(val){
  let s = (val ?? '').toString().trim();
  if (!s) return 0;
  s = s.replace(/[^0-9,.-]/g, '');
  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && hasDot){
    const decPos = Math.max(s.lastIndexOf(','), s.lastIndexOf('.'));
    const intPart = s.slice(0, decPos).replace(/[.,]/g, '');
    const decPart = s.slice(decPos+1).replace(/[.,]/g, '');
    s = intPart + '.' + decPart;
  } else if (hasComma && !hasDot){
    s = s.replace(/\./g, '').replace(',', '.');
  } else {
    s = s.replace(/,/g, '');
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function formatMoneyUSD(n){
  const x = Number(n);
  return Number.isFinite(x)
    ? '$' + x.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    : '$0.00';
}

// Normalize keys to compare reliably
function normKey(s){
  return (s ?? '')
    .toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // strip accents
    .trim().toLowerCase()
    .replace(/\s+/g,'_')
    .replace(/[^a-z0-9_]/g,'');
}

// Try to read row[col] with fallbacks / aliases
function getRowValue(row, col){
  if (!row) return '';
  if (col in row) return row[col] ?? '';
  const nkCol = normKey(col);
  // exact normalized match
  for (const k of Object.keys(row)){
    if (normKey(k) === nkCol) return row[k] ?? '';
  }
  // aliases for Monto_Cargo
  if (nkCol === 'monto_cargo'){
    const aliases = new Set(['monto_cargo','monto','monto_de_cargo','amount','monto_carg']);
    for (const k of Object.keys(row)){
      if (aliases.has(normKey(k))) return row[k] ?? '';
    }
  }
  return '';
}


// --- Normalizadores y formato dinero (ya los usas; incluyo por si faltan) ---
function parseToNumber(val){
  let s = (val ?? '').toString().trim();
  if (!s) return 0;
  s = s.replace(/[^0-9,.-]/g, '');
  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && hasDot){
    const decPos = Math.max(s.lastIndexOf(','), s.lastIndexOf('.'));
    const intPart = s.slice(0, decPos).replace(/[.,]/g, '');
    const decPart = s.slice(decPos+1).replace(/[.,]/g, '');
    s = intPart + '.' + decPart;
  } else if (hasComma && !hasDot){
    s = s.replace(/\./g, '').replace(',', '.');
  } else {
    s = s.replace(/,/g, '');
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function formatMoneyUSD(n){
  const x = Number(n);
  return Number.isFinite(x)
    ? '$' + x.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    : '$0.00';
}

// --- Fecha YYYYMMDD a n√∫mero para comparar ---
function yyyymmddToNum(s){
  const t = (s ?? '').toString().trim();
  if (!/^\d{8}$/.test(t)) return NaN;
  return Number(t);
}

// Never crash the whole app if one feature fails
function safe(fn){ try { return fn(); } catch(e){ console.error('[SAFE]', e); } }

  // MAIN APP SCRIPT
  document.addEventListener('DOMContentLoaded', () => {
    // ======== CONSTANTES (evita TDZ) ========
    const CUENTAS_KEY  = 'opera_zeus_cuentas_contables_v2';
    const CUENTAS_COLS = [
      'Codigo de Concepto Opera', 'Nombre Concepto Opera', 'Cuenta Contable Zeus', 'Centro de costo', 'BU', 'Libro', 'Auxiliar Abierto', 'Moneda', 'Banco', 'Plaza'
    ];

    const ARTICULOS_KEY  = 'opera_zeus_articulos_v1';
    const ARTICULOS_COLS = [
      'Codigo de producto Simphony', 'Nombre de producto Simphony', 'Codigo de articulo Zeus', 'Centro de Costo Zeus', 'Codigo Bodega Zeus'
    ];

    // Columnas esperadas del archivo de Contabilizaci√≥n (tab separado)
const CONTAB_COLS = [
  'Fecha','Codigo_Cargo_Opera','Nombre_Cargo_Opera','Monto_Cargo','Nombre_Cliente','ID_Cliente',
  'Telefono_Cliente','Direccion_Cliente','email_Cliente','Ciudad_Cliente','Pais_Cliente',
  'Col_M','Col_N','Col_O','Factura','Col_P','Col_Q',
  'Tipo_Documento_Cliente','Tipo_Factura','Vencimiento_Factura','Col_U','Folio','Col_W'
];

  let contabRows = [];          // ya existe en tu c√≥digo
let contabFiltered = [];      // filas filtradas + ordenadas para render
let contabSort = { key: null, dir: 1 }; // 1=asc, -1=desc

    // memoria en runtime para las filas cargadas de Contabilizaci√≥n
    let contabRows = [];

    // ======== CUENTAS ========
    function getCuentasTableData(){
      const rows = [];
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas totalmente vac√≠as
        const obj = {};
        CUENTAS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderCuentasTable(data){
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        CUENTAS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      const rows = getCuentasTableData();
      localStorage.setItem(CUENTAS_KEY, JSON.stringify(rows)); // backup offline
      try {
        const res = await saveCuentasToSupabase(rows);
        if (st) st.textContent = 'Guardado en Supabase (' + rows.length + ' filas)';
        if (tsLabel && res && res.updated_at) tsLabel.textContent = formatTimestamp(res.updated_at);
      } catch (e) {
        console.error('Error guardando en Supabase:', e);
        if (st) st.textContent = 'Guardado local (' + rows.length + ' filas). Supabase no est√° disponible.';
      }
    }

    async function loadCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      try{
        let rows = [];
        let updated_at = null;
        try {
          const res = await loadCuentasFromSupabase();
          rows = res.rows; updated_at = res.updated_at;
        } catch (_e) {
          const rawLocal = localStorage.getItem(CUENTAS_KEY);
          rows = rawLocal ? JSON.parse(rawLocal) : [];
          updated_at = null;
        }
        renderCuentasTable(rows);
        if (st) st.textContent = rows.length ? 'Configuraci√≥n cargada' : '';
        if (tsLabel) tsLabel.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
      } catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
    }


    // ======== CONFIGURACI√ìN GENERAL ========
const GENERAL_KEY = 'opera_zeus_config_general_v1';

function sanitizeDigits(str){ return (str||'').replace(/\D+/g,''); }
function sanitizeAlnum(str){ return (str||'').replace(/[^a-zA-Z0-9]+/g,''); }

async function saveGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');

  const cuentaH = sanitizeDigits(document.getElementById('inpCuentaHuespedes')?.value);
  const codVend = sanitizeAlnum(document.getElementById('inpCodVendedor')?.value);
  const cuentaC = sanitizeDigits(document.getElementById('inpCuentaPorCobrar')?.value);

  const obj = {
    cuenta_saldo_huespedes_en_casa: cuentaH || '',
    codigo_vendedor_default: codVend || '',
    cuenta_por_cobrar_default: cuentaC || ''
  };

  // Backup local
  localStorage.setItem(GENERAL_KEY, JSON.stringify(obj));

  try{
    const res = await saveGeneralToSupabase(obj);
    if (st) st.textContent = 'Guardado en Supabase';
    if (ts && res?.updated_at) ts.textContent = formatTimestamp(res.updated_at);
  }catch(e){
    console.error('Error guardando Configuraci√≥n General en Supabase:', e);
    if (st) st.textContent = 'Guardado local. Supabase no est√° disponible.';
  }
}

async function loadGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');
  try{
    let data = null, updated_at = null;
    try{
      const res = await loadGeneralFromSupabase();
      data = res.data; updated_at = res.updated_at;
    }catch(_e){
      const raw = localStorage.getItem(GENERAL_KEY);
      data = raw ? JSON.parse(raw) : null;
    }

    if (data){
      const inpH = document.getElementById('inpCuentaHuespedes');
      const inpV = document.getElementById('inpCodVendedor');
      const inpC = document.getElementById('inpCuentaPorCobrar');
      if (inpH) inpH.value = sanitizeDigits(data.cuenta_saldo_huespedes_en_casa || '');
      if (inpV) inpV.value = sanitizeAlnum(data.codigo_vendedor_default || '');
      if (inpC) inpC.value = sanitizeDigits(data.cuenta_por_cobrar_default || '');
      if (st) st.textContent = 'Configuraci√≥n cargada';
      if (ts) ts.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
    } else {
      if (st) st.textContent = '';
      if (ts) ts.textContent = '(sin publicar)';
    }
  }catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
}

function initGeneralPage(){
  const h = document.getElementById('inpCuentaHuespedes');
  const v = document.getElementById('inpCodVendedor');
  const c = document.getElementById('inpCuentaPorCobrar');
  if (h && !h._bound){ h.addEventListener('input', () => { h.value = sanitizeDigits(h.value); }); h._bound = true; }
  if (v && !v._bound){ v.addEventListener('input', () => { v.value = sanitizeAlnum(v.value); }); v._bound = true; }
  if (c && !c._bound){ c.addEventListener('input', () => { c.value = sanitizeDigits(c.value); }); c._bound = true; }
  const btn = document.getElementById('generalSave');
  if (btn && !btn._bound){ btn.addEventListener('click', saveGeneralConfig); btn._bound = true; }
}


    
    // ======== ART√çCULOS ========
    function getArticulosTableData(){
      const rows = [];
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas vac√≠as
        const obj = {};
        ARTICULOS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderArticulosTable(data){
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        ARTICULOS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        const rows = getArticulosTableData();
        // Evita borrar datos remotos: si no hay filas v√°lidas, no escribas en Supabase
        if (!rows || rows.length === 0){
          // Mant√©n backup local, pero NO sobrescribas remoto con []
          localStorage.setItem(ARTICULOS_KEY, JSON.stringify([]));
          if (status) status.textContent = 'No hay filas para guardar. Se mantiene el contenido de Supabase sin cambios.';
          return false;
        }
        // backup local siempre
        localStorage.setItem(ARTICULOS_KEY, JSON.stringify(rows));
        // intenta Supabase
        const res = await saveArticulosToSupabase(rows);
        if (status) status.textContent = 'Guardado en Supabase ('+ rows.length +' fila(s))' + (res?.updated_at ? ' ‚Ä¢ '+formatTimestamp(res.updated_at) : '');
        return true;
      }catch(e){
        console.error('Error guardando art√≠culos en Supabase:', e);
        const rows = getArticulosTableData();
        if (status) status.textContent = 'Guardado local ('+ rows.length +' fila(s)). Supabase no est√° disponible.';
        return false;
      }
    }

    async function loadArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        let rows = [];
        try {
          const res = await loadArticulosFromSupabase();
          rows = res.rows;
          if (status) status.textContent = rows.length ? 'Configuraci√≥n cargada desde Supabase' : '';
        } catch (_e){
          const raw = localStorage.getItem(ARTICULOS_KEY);
          rows = raw ? JSON.parse(raw) : [];
          if (status) status.textContent = rows.length ? 'Configuraci√≥n cargada (local)' : '';
        }
        renderArticulosTable(rows);
      }catch(e){ if (status) status.textContent = 'No se pudo cargar: ' + e.message; }
    }

    // ======== CONTABILIZACI√ìN (TSV/TXT) ========
    function parseTSV(text){
      // Normaliza saltos de l√≠nea (CRLF/CR -> LF) y descarta l√≠neas totalmente vac√≠as
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== '');
      const parsed = [];
      for (const line of lines){
        const parts = line.split("\t");
        const obj = {};
        CONTAB_COLS.forEach((col, idx) => { obj[col] = (parts[idx] ?? '').trim(); });
        parsed.push(obj);
      }
      return parsed;
    }

function renderContabTable(rows){
  const thead = document.getElementById('contabHead');
  const tbody = document.getElementById('contabBody');
  if (!thead || !tbody) return;

  // Fallback columns if CONTAB_COLS is missing
  const cols = Array.isArray(window.CONTAB_COLS) && window.CONTAB_COLS.length
    ? window.CONTAB_COLS
    : ['Fecha','Codigo_Cargo_Opera','Nombre_Cargo_Opera','Monto_Cargo'];

  // Clear
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // Header (DOM API to avoid weird disappearing text)
  const trHead = document.createElement('tr');
  cols.forEach(label => {
    const th = document.createElement('th');
    th.textContent = label;
    th.style.whiteSpace = 'nowrap';
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  if (!rows || !rows.length){
    // keep header visible
    return safe(() => {
      if (typeof enableHeaderSorting === 'function') enableHeaderSorting();
      if (typeof paintSortIndicators === 'function') paintSortIndicators();
    });
  }

  const frag = document.createDocumentFragment();
  rows.forEach(row => {
    const tr = document.createElement('tr');
    cols.forEach(col => {
      const td = document.createElement('td');
      let raw = (col in row) ? row[col] : (row[col?.trim()] ?? '');

      if (col === 'Monto_Cargo') {
        // tolerate helpers not being present
        if (typeof parseToNumber === 'function' && typeof formatMoneyUSD === 'function') {
          td.textContent = formatMoneyUSD(parseToNumber(raw));
        } else {
          td.textContent = raw ?? '';
        }
      } else {
        td.textContent = raw ?? '';
      }
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });

  tbody.appendChild(frag);

  // Sorting decorations guarded
  safe(() => {
    if (typeof enableHeaderSorting === 'function') enableHeaderSorting();
    if (typeof paintSortIndicators === 'function') paintSortIndicators();
  });
}


 function applyFilters(){
  // Lee filtros
  const df = document.getElementById('contabDateFrom')?.value.trim();
  const dt = document.getElementById('contabDateTo')?.value.trim();
  const mn = document.getElementById('contabMontoMin')?.value.trim();
  const mx = document.getElementById('contabMontoMax')?.value.trim();
  const q  = (document.getElementById('contabTextSearch')?.value || '').toLowerCase();

  const numDF = df ? yyyymmddToNum(df) : NaN;
  const numDT = dt ? yyyymmddToNum(dt) : NaN;
  const numMN = mn ? parseToNumber(mn) : NaN;
  const numMX = mx ? parseToNumber(mx) : NaN;

  let out = contabRows.slice();

  out = out.filter(r => {
    // Fecha
    const f = yyyymmddToNum(r['Fecha']);
    if (!isNaN(numDF) && !isNaN(f) && f < numDF) return false;
    if (!isNaN(numDT) && !isNaN(f) && f > numDT) return false;
    // Monto
    const m = parseToNumber(r['Monto_Cargo']);
    if (!isNaN(numMN) && m < numMN) return false;
    if (!isNaN(numMX) && m > numMX) return false;
    // Texto (cualquier columna)
    if (q){
      const hit = CONTAB_COLS.some(c => (r[c] ?? '').toString().toLowerCase().includes(q));
      if (!hit) return false;
    }
    return true;
  });

  // Orden actual
  if (contabSort.key){
    const k = contabSort.key;
    const dir = contabSort.dir;
    out.sort((a,b) => {
      if (k === 'Monto_Cargo') {
        return (parseToNumber(a[k]) - parseToNumber(b[k])) * dir;
      } else if (k === 'Fecha'){
        return (yyyymmddToNum(a[k]) - yyyymmddToNum(b[k])) * dir;
      } else {
        const A = (a[k] ?? '').toString().toLowerCase();
        const B = (b[k] ?? '').toString().toLowerCase();
        if (A < B) return -1*dir;
        if (A > B) return  1*dir;
        return 0;
      }
    });
  }

  contabFiltered = out;
  renderContabTable(out);   // tu renderer existente
  enableHeaderSorting();
  paintSortIndicators();
  updateTotals();
  paintSortIndicators();

 }

function updateTotals(){
  const tot = document.getElementById('contabTotals');
  if (!tot) return;
  const sum = contabFiltered.reduce((acc,r) => acc + parseToNumber(r['Monto_Cargo']), 0);
  tot.textContent = `Filas: ${contabFiltered.length} ‚Ä¢ Total Monto_Cargo: ${formatMoneyUSD(sum)}`;
}

function paintSortIndicators(){
  // Marca ‚ñ≤‚ñº en el th de la columna ordenada
  const head = document.getElementById('contabHead');
  if (!head) return;
  const ths = head.querySelectorAll('th');
  ths.forEach((th, idx) => {
    const col = CONTAB_COLS[idx];
    const base = col;
    if (contabSort.key === col){
      th.textContent = `${base} ${contabSort.dir === 1 ? '‚ñ≤' : '‚ñº'}`;
    } else {
      th.textContent = base;
    }
  });
}

// Hook: al terminar de renderizar cabecera, conectar eventos de orden
function enableHeaderSorting(){
  const head = document.getElementById('contabHead');
  if (!head) return;
  const ths = head.querySelectorAll('th');
  ths.forEach((th, idx) => {
    const col = CONTAB_COLS[idx];
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      if (contabSort.key === col){
        contabSort.dir = -contabSort.dir; // toggle
      } else {
        contabSort.key = col;
        contabSort.dir = 1;
      }
      applyFilters();
    });
  });
}

// Exporta a Excel si est√° XLSX, si no, CSV
function exportContab(){
  const rows = contabFiltered.length ? contabFiltered : contabRows;
  if (!rows.length){ alert('No hay filas para exportar'); return; }

  // Construye objeto plano en orden CONTAB_COLS
  const data = rows.map(r => {
    const obj = {};
    CONTAB_COLS.forEach(c => {
      if (c === 'Monto_Cargo'){
        // n√∫mero crudo para Excel (no $), Excel aplica formato num√©rico
        obj[c] = parseToNumber(r[c]);
      } else {
        obj[c] = r[c] ?? '';
      }
    });
    return obj;
  });

  if (window.XLSX){
    const ws = XLSX.utils.json_to_sheet(data, { header: CONTAB_COLS });
    // Estilo b√°sico: formato num√©rico a Monto_Cargo
    const ref = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 1; R <= (ref.e.r); R++){
      const cell = XLSX.utils.encode_cell({ r:R, c: CONTAB_COLS.indexOf('Monto_Cargo') });
      if (ws[cell]) ws[cell].z = '#,##0.00';
    }
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Contabilizacion');
    XLSX.writeFile(wb, 'Contabilizacion_Zeus.xlsx');
  } else {
    // Fallback CSV
    const header = CONTAB_COLS.join(',');
    const body = data.map(row =>
      CONTAB_COLS.map(k => {
        const v = row[k];
        const s = (v ?? '').toString().replace(/"/g,'""');
        return `"${s}"`;
      }).join(',')
    ).join('\n');
    const csv = header + '\n' + body + '\n';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'Contabilizacion_Zeus.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}

  // Clear
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // Header (DOM, no innerHTML)
  const trHead = document.createElement('tr');
  CONTAB_COLS.forEach(label => {
    const th = document.createElement('th');
    th.textContent = label;          // <= ensures "Monto_Cargo" always visible
    th.style.whiteSpace = 'nowrap';  // keep header readable
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // Body
  if (!rows || !rows.length) return;

  const frag = document.createDocumentFragment();
  rows.forEach(row => {
    const tr = document.createElement('tr');
    CONTAB_COLS.forEach(col => {
      const td = document.createElement('td');
      const raw = (col in row) ? row[col] : '';

      if (col === 'Monto_Cargo') {
        td.textContent = formatMoneyUSD(parseToNumber(raw));
      } else {
        td.textContent = raw ?? '';
      }
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}




    function initContabilizacionPage(){
      const fileInput = document.getElementById('contabFile');
      const dz        = document.getElementById('contabDropZone');
      const status    = document.getElementById('contabStatus');
      const genBtn    = document.getElementById('contabGenerate');

        ['contabDateFrom','contabDateTo','contabMontoMin','contabMontoMax','contabTextSearch']
          .forEach(id => {
            const el = document.getElementById(id);
            if (el && !el._bound){
              el.addEventListener('input', applyFilters);
              el._bound = true;
            }
          });
        
        const btnX = document.getElementById('contabExportXLS');
        if (btnX && !btnX._bound){
          btnX.addEventListener('click', exportContab);
          btnX._bound = true;
        }

      const genTerBtn = document.getElementById('contabGenerateTerceros');
      if (genTerBtn && !genTerBtn._bound){
        genTerBtn.addEventListener('click', () => {
          const st = document.getElementById('contabStatus');
          const rows = buildTercerosRows(contabRows);
          if (!rows.length){ if (st) st.textContent = 'No hay filas con Tipo_Documento_Cliente.'; return; }
          const content = rows.map(r => r.join(';')).join('\n');
          downloadText('Terceros_Zeus.txt', content);
          if (st) st.textContent = 'Generado Terceros_Zeus.txt ('+rows.length+' fila(s))';
        });
        genTerBtn._bound = true;
      }

      async function handleFile(file){
        if (!file) return;
        try { const text = await file.text(); contabRows = parseTSV(text); applyFilters(); if (status) status.textContent = 'Cargadas ' + contabRows.length + ' fila(s)'; }
        catch (err){ if (status) status.textContent = 'Error leyendo archivo: ' + err.message; }
      }

      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', (e) => { const file = e.target.files?.[0]; handleFile(file); });
        fileInput._bound = true;
      }

      if (dz && !dz._bound){
        dz.addEventListener('click', () => { fileInput?.click(); });
        dz.addEventListener('dragover', (ev) => { ev.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (ev) => { ev.preventDefault(); dz.classList.remove('dragover'); const file = ev.dataTransfer?.files?.[0]; handleFile(file); });
        dz._bound = true;
      }

      if (genBtn && !genBtn._bound){
        genBtn.addEventListener('click', () => {
          const rowsCount = contabRows.length || 0;
          console.log('Generar Archivo Contabilizacion Zeus - filas:', rowsCount, contabRows);
          if (status) status.textContent = 'Generado archivo (simulado) con ' + rowsCount + ' fila(s).';
          // TODO: definir formato final (descarga .txt/.csv √≥ env√≠o a API)
        });
        genBtn._bound = true;
      }
    }

    // ======== UTILIDADES GENERALES ========
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function formatTimestamp(iso){
      if (!iso) return '(sin publicar)';
      const d = new Date(iso); if (isNaN(d.getTime())) return iso;
      const yyyy = d.getUTCFullYear(); const mm = pad2(d.getUTCMonth()+1); const dd = pad2(d.getUTCDate());
      const hh = pad2(d.getUTCHours()); const mi = pad2(d.getUTCMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi} UTC`;
    }

    // === Helpers para descarga y normalizaci√≥n (Terceros Zeus) ===
function downloadText(filename, content){
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}

// ======== TERCEROS (helpers y generador de filas) ========
// Normaliza nombres de pa√≠s (quita acentos, colapsa espacios, a min√∫sculas)
function normalizeStrForCountry(s){
  return (s||'').toString().trim().normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ');
}

// ISO 3166-1 alpha-2 (en / es comunes). Si ya viene en 2 letras, respeta.
function toISO2Country(name){
  if (!name) return '';
  const raw = name.toString().trim();
  if (/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();
  const key = normalizeStrForCountry(raw);
  const m = {"afghanistan":"AF","albania":"AL","algeria":"DZ","andorra":"AD","angola":"AO","antigua and barbuda":"AG",
"argentina":"AR","armenia":"AM","australia":"AU","austria":"AT","azerbaijan":"AZ","bahamas":"BS","bahrain":"BH","bangladesh":"BD","barbados":"BB","belarus":"BY","belgium":"BE","belize":"BZ",
"benin":"BJ","bhutan":"BT","bolivia":"BO","bosnia and herzegovina":"BA","botswana":"BW","brazil":"BR","brunei":"BN","bulgaria":"BG","burkina faso":"BF","burundi":"BI","cabo verde":"CV","cambodia":"KH","cameroon":"CM",
"canada":"CA","central african republic":"CF","chad":"TD","chile":"CL","china":"CN","colombia":"CO","comoros":"KM","congo":"CG","costa rica":"CR","croatia":"HR","cuba":"CU","cyprus":"CY","czech republic":"CZ","czechia":"CZ",
"denmark":"DK","djibouti":"DJ","dominica":"DM","dominican republic":"DO","republica dominicana":"DO","rep√∫blica dominicana":"DO","ecuador":"EC","egypt":"EG","el salvador":"SV","equatorial guinea":"GQ","eritrea":"ER","estonia":"EE",
"eswatini":"SZ","ethiopia":"ET","fiji":"FJ","finland":"FI","france":"FR","gabon":"GA","gambia":"GM","georgia":"GE","germany":"DE","ghana":"GH","greece":"GR","grenada":"GD","guatemala":"GT","guinea":"GN","guinea-bissau":"GW","guyana":"GY",
"haiti":"HT","honduras":"HN","hungary":"HU","iceland":"IS","india":"IN","indonesia":"ID","iran":"IR","iraq":"IQ","ireland":"IE","israel":"IL","italy":"IT","jamaica":"JM","japan":"JP","japon":"JP","jap√≥n":"JP","jordan":"JO",
"kazakhstan":"KZ","kenya":"KE","kiribati":"KI","kosovo":"XK","kuwait":"KW","kyrgyzstan":"KG","laos":"LA","latvia":"LV","lebanon":"LB","lesotho":"LS","liberia":"LR","libya":"LY","liechtenstein":"LI","lithuania":"LT","luxembourg":"LU",
"madagascar":"MG","malawi":"MW","malaysia":"MY","maldives":"MV","mali":"ML","malta":"MT","marshall islands":"MH","mauritania":"MR","mauritius":"MU","mexico":"MX","m√©xico":"MX","micronesia":"FM","moldova":"MD","monaco":"MC","mongolia":"MN","montenegro":"ME","morocco":"MA","mozambique":"MZ",
"myanmar":"MM","namibia":"NA","nauru":"NR","nepal":"NP","netherlands":"NL","new zealand":"NZ","nicaragua":"NI","niger":"NE","nigeria":"NG","north korea":"KP","north macedonia":"MK","norway":"NO",
"oman":"OM","pakistan":"PK","palau":"PW","panama":"PA","panam√°":"PA","papua new guinea":"PG","paraguay":"PY","peru":"PE","per√∫":"PE","philippines":"PH","poland":"PL","portugal":"PT","qatar":"QA","romania":"RO","russia":"RU","russian federation":"RU","rwanda":"RW",
"saint kitts and nevis":"KN","saint lucia":"LC","saint vincent and the grenadines":"VC","samoa":"WS","san marino":"SM","sao tome and principe":"ST","saudi arabia":"SA","senegal":"SN","serbia":"RS","seychelles":"SC","sierra leone":"SL","singapore":"SG","slovakia":"SK","slovenia":"SI","solomon islands":"SB","somalia":"SO","south africa":"ZA","south korea":"KR","korea":"KR","south sudan":"SS","spain":"ES","espa√±a":"ES","sri lanka":"LK","sudan":"SD","suriname":"SR","sweden":"SE","switzerland":"CH","syria":"SY",
"taiwan":"TW","tajikistan":"TJ","tanzania":"TZ","thailand":"TH","timor-leste":"TL","togo":"TG","tonga":"TO","trinidad and tobago":"TT","tunisia":"TN","turkey":"TR","turkiye":"TR","turkmenistan":"TM","tuvalu":"TV",
"uganda":"UG","ukraine":"UA","united arab emirates":"AE","uae":"AE","united kingdom":"GB","reino unido":"GB","uk":"GB","united states":"US","estados unidos":"US","usa":"US","uruguay":"UY","uzbekistan":"UZ",
"vanuatu":"VU","vatican city":"VA","venezuela":"VE","vietnam":"VN","yemen":"YE","zambia":"ZM","zimbabwe":"ZW"};
  return m[key] || '';
}

// Limpia ; y trim
function safeField(v){ return (v||'').toString().trim().replace(/;/g,' '); }

// ‚úÖ Construye filas para Terceros_Zeus.txt **sin duplicados**
//   - Filtra filas con Tipo_Documento_Cliente no vac√≠o
//   - Duplicado = mismo (ID_Cliente, Nombre_Cliente) tras trim/lower
function buildTercerosRows(rows){
  const filtered = (rows||[]).filter(r => (r['Tipo_Documento_Cliente']||'').toString().trim() !== '');
  const seen = new Set();
  const out = [];
  for (const r of filtered){
    const id = safeField(r['ID_Cliente']);
    const name = safeField(r['Nombre_Cliente']);
    if (!id || !name) continue; // ignora filas sin clave
    const key = id + '||' + name.toLowerCase();
    if (seen.has(key)) continue; // üîÅ elimina duplicados
    seen.add(key);

    const tipoDoc = (r['Tipo_Documento_Cliente']||'').toString().trim();
    const direccion = safeField(r['Direccion_Cliente']);
    const ciudad = safeField(r['Ciudad_Cliente']);
    const tel = safeField(r['Telefono_Cliente']);
    const pais = safeField(r['Pais_Cliente']);

    const jn = (tipoDoc === '11') ? 'J' : 'N';
    let docType = '';
    if (tipoDoc === '13') docType = 'CC';
    else if (tipoDoc === '41') docType = 'PAP';
    else if (tipoDoc === '11') docType = 'NIT';

    const iso = toISO2Country(pais);

    const row = [
      id,            // 1  ID_Cliente
      name,          // 2  Nombre_Cliente
      '',            // 3  empty
      jn,            // 4  J / N
      'OTROS',       // 5  literal
      '48',          // 6  literal 48
      direccion,     // 7  Direccion_Cliente
      ciudad,        // 8  Ciudad_Cliente
      '',            // 9  empty
      '',            // 10 empty
      tel,           // 11 Telefono_Cliente
      docType,       // 12 tipo doc mapeado
      '', '', '', '',// 13-16 empties
      name,          // 17 Nombre_Cliente
      '', '', '', '', '', '', '', '', '', // 18-26 empties
      iso,           // 27 ISO2 pa√≠s
      'N'            // 28 literal
    ].map(s => (s||'').toString().trim());

    out.push(row);
  }
  return out;
}


    
    // ======== PARSER XML (Ventas) ========
    const parseText = (node, sel) => (node.querySelector(sel)?.textContent ?? '').trim();
    const parseAttr = (node, name, fallback='') => (node.getAttribute(name) ?? fallback);

    function buildBillsRows(xml){
      const bills = Array.from(xml.querySelectorAll('bill'));
      return bills.map(bill => {
        const resInfo = bill.querySelector('reservation_info');
        const extInfo = bill.querySelector('external_fiscal_info');
        return {
          customer_internal_id: parseAttr(bill, 'customer_internal_id'),
          bill_no: parseText(bill, 'bill_no'),
          bill_type: parseText(bill, 'bill_type'),
          status: parseText(bill, 'status'),
          total_amount: parseText(bill, 'total_amount'),
          name_tax_type: parseText(bill, 'name_tax_type'),
          invoice_no: parseText(bill, 'invoice_no'),
          guest_internal_id: parseText(bill, 'guest_internal_id'),
          confirmation_no: resInfo ? parseText(resInfo, 'confirmation_no') : '',
          arrival_date: resInfo ? parseText(resInfo, 'arrival_date') : '',
          departure_date: resInfo ? parseText(resInfo, 'departure_date') : '',
          guest_name: resInfo ? parseText(resInfo, 'guest_name') : '',
          fiscal_bill_no: extInfo ? parseText(extInfo, 'fiscal_bill_no') : ''
        };
      });
    }

    function buildTransactionsRows(xml){
      const rows = [];
      xml.querySelectorAll('bill').forEach(bill => {
        const billNo = parseText(bill, 'bill_no');
        const guest = bill.querySelector('reservation_info > guest_name')?.textContent?.trim() || '';
        bill.querySelectorAll('bill_detail > transaction').forEach(trx => {
          rows.push({
            bill_no: billNo,
            guest_name: guest,
            trx_no: parseAttr(trx, 'trx_no'),
            trx_no_added_by: parseAttr(trx, 'trx_no_added_by', ''),
            trx_code: parseText(trx, 'trx_code'),
            trx_date: parseText(trx, 'trx_date'),
            cheque_number: parseText(trx, 'cheque_number'),
            net_amount: parseText(trx, 'net_amount'),
            debit_amount: parseText(trx, 'debit_amount'),
            credit_amount: parseText(trx, 'credit_amount'),
            foreign_currency: parseText(trx, 'foreign_currency'),
            foreign_amount: parseText(trx, 'foreign_amount')
          });
        });
      });
      return rows;
    }

    function renderTable(tableEl, rows){
      const thead = tableEl.querySelector('thead');
      const tbody = tableEl.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if (!rows || !rows.length) { thead.innerHTML = '<tr><th>Sin datos</th></tr>'; return; }
      const cols = Object.keys(rows[0]);
      thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        cols.forEach(c => { const td = document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function initVentasPage(){
      // Pesta√±as (Facturas / Transacciones)
      document.querySelectorAll('#ventas .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('#ventas .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-target');
        ['#billsTableWrap','#trxTableWrap'].forEach(id => {
          const el = document.querySelector(id); if (!el) return; el.style.display = (id === target) ? 'block' : 'none';
        });
      }));

      // File input XML Opera
      const fileInput = document.getElementById('xmlFile');
      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          const status = document.getElementById('ventasStatus');
          if (!file) return;
          try {
            const text = await file.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'application/xml');
            const err = xml.querySelector('parsererror');
            if (err) throw new Error('XML inv√°lido');
            const billRows = buildBillsRows(xml);
            const trxRows  = buildTransactionsRows(xml);
            renderTable(document.getElementById('billsTable'), billRows);
            renderTable(document.getElementById('trxTable'),  trxRows);
            if (status) status.textContent = `Cargadas ${billRows.length} factura(s) y ${trxRows.length} transacci√≥n(es)`;
          } catch (ex){ if (status) status.textContent = 'Error: ' + ex.message; }
        });
        fileInput._bound = true;
      }
    }

    // ======== NAV / EVENTOS ========
    const menuItems = document.querySelectorAll('.menu-item');

// Call inside DOMContentLoaded
function showSection(id){
  // hide all
  document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));

  const el = document.getElementById(id);
  if (el) el.classList.remove('hidden');

  // lazy init per page, all guarded
  if (id === 'configgeneral')  safe(() => { initGeneralPage();   loadGeneralConfig(); });
  if (id === 'cuentas')        safe(() => { loadCuentasConfig(); });
  if (id === 'articulos')      safe(() => { loadArticulosConfig(); });
  if (id === 'ventas')         safe(() => { initVentasPage();    });
  if (id === 'contabilizacion') safe(() => { initContabilizacionPage(); applyFilters?.(); });
}

// Sidebar binding (re-bind safely even if run twice)
(function bindSidebar(){
  const items = document.querySelectorAll('.menu-item');
  items.forEach(item => {
    if (item._bound) return;
    item.addEventListener('click', () => {
      items.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      showSection(item.getAttribute('data-section'));
    });
    item._bound = true;
  });
})();


    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const target = item.getAttribute('data-section');
        showSection(target);
      });
    });

    // Botones cuentas contables
    document.getElementById('cuentasSave')?.addEventListener('click', saveCuentasConfig);
    document.getElementById('cuentasAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#cuentasTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      CUENTAS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // Botones art√≠culos
    document.getElementById('articulosSave')?.addEventListener('click', saveArticulosConfig);
    document.getElementById('articulosAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#articulosTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      ARTICULOS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // ======== INICIALIZACI√ìN POR DEFECTO ========
    showSection('cuentas');
    document.querySelector('.menu-item[data-section="cuentas"]').classList.add('active');

    // ======== TESTS ========
    (function runSmokeTests(){
      try {
        // Estructura b√°sica esperada
        console.assert(Array.isArray(CUENTAS_COLS) && CUENTAS_COLS.length === 10, 'CUENTAS_COLS debe tener 10 columnas');
        console.assert(Array.isArray(ARTICULOS_COLS) && ARTICULOS_COLS.length === 5,  'ARTICULOS_COLS debe tener 5 columnas');
        console.assert(Array.isArray(CONTAB_COLS)  && CONTAB_COLS.length === 23, 'CONTAB_COLS debe tener 23 columnas');

        // Test de persistencia local para Art√≠culos
        const keyTest = ARTICULOS_KEY + '_test';
        const sample = [{
          'Codigo de producto Simphony': 'P001',
          'Nombre de producto Simphony': 'Producto Demo',
          'Codigo de articulo Zeus': 'Z-100',
          'Centro de Costo Zeus': 'CC01',
          'Codigo Bodega Zeus': 'B01'
        }];
        localStorage.setItem(keyTest, JSON.stringify(sample));
        const got = JSON.parse(localStorage.getItem(keyTest) || '[]');
        console.assert(got.length === 1 && got[0]['Codigo de articulo Zeus'] === 'Z-100', 'Persistencia b√°sica localStorage (art√≠culos)');
        localStorage.removeItem(keyTest);

        // Tests adicionales para parseTSV (LF / CRLF / CR) y mapeo de columnas
        const tsv1 = '2025-11-01\tC001\n2025-11-02\tC002\n';
        const res1 = parseTSV(tsv1);
        console.assert(res1.length === 2, 'parseTSV debe leer 2 filas (LF)');
        console.assert(res1[0]['Fecha'] === '2025-11-01' && res1[0]['Codigo_Cargo_Opera'] === 'C001', 'parseTSV mapea columnas (LF)');

        const tsv2 = '2025-11-03\tC010\r\n2025-11-04\tC020\r\n';
        const res2 = parseTSV(tsv2);
        console.assert(res2.length === 2, 'parseTSV debe leer 2 filas (CRLF)');
        console.assert(res2[1]['Fecha'] === '2025-11-04' && res2[1]['Codigo_Cargo_Opera'] === 'C020', 'parseTSV mapea columnas (CRLF)');

        const tsv3 = '2025-11-05\tC100\r2025-11-06\tC200\r';
        const res3 = parseTSV(tsv3);
        console.assert(res3.length === 2, 'parseTSV debe leer 2 filas (CR)');
        console.assert(res3[0]['Fecha'] === '2025-11-05' && res3[0]['Codigo_Cargo_Opera'] === 'C100', 'parseTSV mapea columnas (CR)');

        // Test Col_O insertado entre Col_N y Factura
        const tsv4 = '2025-12-01\tC777\tCargo X\t1500\tJuan Perez\tID777\t3000000000\tCalle 123\tjuan@x.com\tBogot√°\tCO\tMVAL\tNVAL\tOVAL\tF001\tPVAL\tQVAL\tCC\tFAC\t2025-12-10\tUVAL\tFOLIOX\tWVAL\n';
        const res4 = parseTSV(tsv4);
        console.assert(res4.length === 1, 'parseTSV debe leer 1 fila (Col_O)');
        console.assert(res4[0]['Col_O'] === 'OVAL' && res4[0]['Factura'] === 'F001', 'Col_O correctamente mapeada y en orden');

        // Tests de UI b√°sicos
        console.assert(document.getElementById('cuentasTable') instanceof HTMLTableElement, 'Tabla de cuentas existe');
        console.assert(document.getElementById('contabTable') instanceof HTMLTableElement, 'Tabla de contabilizaci√≥n existe');

        console.assert(typeof initSupabaseIfNeeded === 'function', 'initSupabaseIfNeeded debe existir');
        console.assert(typeof saveCuentasToSupabase === 'function', 'saveCuentasToSupabase debe existir');
        console.assert(typeof loadCuentasFromSupabase === 'function', 'loadCuentasFromSupabase debe existir');

        // Nuevos helpers de art√≠culos
        console.assert(typeof saveArticulosToSupabase === 'function', 'saveArticulosToSupabase debe existir');
        console.assert(typeof loadArticulosFromSupabase === 'function', 'loadArticulosFromSupabase debe existir');

        console.assert(typeof saveGeneralToSupabase === 'function', 'saveGeneralToSupabase debe existir');
        console.assert(typeof loadGeneralFromSupabase === 'function', 'loadGeneralFromSupabase debe existir');
        console.assert(sanitizeDigits('A1B2C3') === '123', 'sanitizeDigits');
        console.assert(sanitizeAlnum('A-1_B 2!') === 'A1B2', 'sanitizeAlnum');

        
        // Extra: smoke test de invocaci√≥n segura (no debe lanzar)
        (async ()=>{ try { const r = await saveArticulosConfig(); console.assert(r === false, 'saveArticulosConfig vac√≠o debe retornar false y no upsert'); } catch (e) { console.error('saveArticulosConfig lanz√≥ excepci√≥n inesperada', e); } })();

        console.log('%cSmoke tests OK','color:#22c55e');
      } catch (e) { console.error('Smoke tests FAILED', e); }
    })();
  }); // FIN DOMContentLoaded
  </script>
</body>
</html>
