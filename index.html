<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interfaz Opera - Zeus</title>
  <style>
    body {margin: 0; font-family: Arial, sans-serif; background-color: #0f172a; color: #e5e7eb; display: flex;}
    .sidebar {width: 260px; background-color: #111827; border-right: 1px solid #1f2937; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; padding-top: 24px;}
    .sidebar h2 {color: #22c55e; font-size: 18px; margin: 0 0 20px 20px;}
    .menu-item {padding: 12px 20px; color: #94a3b8; text-decoration: none; display: block; transition: background 0.2s; cursor: pointer;}
    .menu-item:hover, .menu-item.active {background-color: #1e293b; color: #22c55e;}
    .content {margin-left: 260px; padding: 20px; width: calc(100% - 260px);}    
    .card {background: #111827; padding: 20px; border-radius: 10px; border: 1px solid #1f2937; margin-bottom: 20px;}
    input, button {border-radius: 6px; border: none; padding: 8px 10px; margin: 5px 0; font-size: 14px;}
    input {width: 100%;}
    button {background-color: #22c55e; color: white; cursor: pointer;}
    button:hover {background-color: #16a34a;}
    table {width: 100%; border-collapse: collapse; color: #e5e7eb; margin-top: 10px;}
    table th, table td {border: 1px solid #1f2937; padding: 8px;}
    table th {background-color: #1e293b;}
    .hidden {display: none;}
    .editable:focus {outline: 2px solid #38bdf8;}
    .drop-zone {margin-top:10px;border:2px dashed #334155;border-radius:10px;padding:20px;text-align:center;color:#94a3b8;background-color:#1e293b;cursor:pointer;}
    .drop-zone.dragover {background-color:#334155;color:#fff;}
  </style>
  <!-- Supabase CDN (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Menú</h2>
    <div class="menu-item" data-section="usuarios" style="display:none">Usuarios</div>
    <div class="menu-item" data-section="clientes" style="display:none">Configuración de Clientes</div>
    <div class="menu-item" data-section="configgeneral">Configuracion General</div>
    <div class="menu-item" data-section="cuentas">Configuración de Cuentas Contables</div>
    <div class="menu-item" data-section="articulos">Configuración de Artículos</div>
    <div class="menu-item" data-section="ventas" style="display:none">Contabilizar Ventas</div>
    <div class="menu-item" data-section="contabilizacion">Contabilización</div>
    <div class="menu-item" data-section="inventario" style="display:none">Actualizar Inventario</div>
    <div class="menu-item" data-section="login" style="display:none">Iniciar Sesión</div>
  </div>

  <div class="content">
    <h1>Interfaz Opera - Zeus v1.03</h1>

    <!-- Configuración General -->
<section id="configgeneral" class="card hidden">
  <h2>Configuración General</h2>

  <div style="display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:center;">
    <label for="inpCuentaHuespedes" style="color:#94a3b8;">Cuenta Saldo Huéspedes en Casa</label>
    <input id="inpCuentaHuespedes" type="text" inputmode="numeric" placeholder="Sólo números" />

    <label for="inpCodVendedor" style="color:#94a3b8;">Código de vendedor por defecto para clientes</label>
    <input id="inpCodVendedor" type="text" placeholder="Alfanumérico" />

    <label for="inpCuentaPorCobrar" style="color:#94a3b8;">Cuenta por cobrar por defecto para clientes</label>
    <input id="inpCuentaPorCobrar" type="text" inputmode="numeric" placeholder="Sólo números" />
  </div>

  <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
    <button id="generalSave" type="button">Guardar</button>
    <span id="generalStatus" style="margin-left:6px;color:#94a3b8"></span>
  </div>

  <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
    <strong>Última actualización:</strong>
    <span id="generalLastUpdated">(sin publicar)</span>
  </div>
</section>


    <!-- Cuentas Contables -->
    <section id="cuentas" class="card hidden">
      <h2>Configuración de Cuentas Contables</h2>

      <div style="overflow:auto">
        <table id="cuentasTable">
          <thead>
            <tr>
              <th>Codigo de Concepto Opera</th>
              <th>Nombre Concepto Opera</th>
              <th>Cuenta Contable Zeus</th>
              <th>Centro de costo</th>
              <th>BU</th>
              <th>Libro</th>
              <th>Auxiliar Abierto</th>
              <th>Moneda</th>
              <th>Banco</th>
              <th>Plaza</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="cuentasAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="cuentasSave" type="button">Guardar</button>
        <span id="cuentasStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>

      <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
        <strong>Última actualización global:</strong>
        <span id="cuentasLastUpdated">(sin publicar)</span>
      </div>
    </section>

    <!-- Contabilización (TSV / TXT) -->
    <section id="contabilizacion" class="card hidden">
      <h2>Contabilización</h2>
      <div class="note" style="color:#94a3b8;margin-bottom:8px">
        Carga un archivo de texto (tab separado) tipo "Cargos_Diarios_Opera.txt" para previsualizarlo.
      </div>

      <div class="row" style="display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;">
        <label for="contabFile" style="color:#94a3b8">Archivo Contabilización</label>
        <input id="contabFile" type="file" accept=".txt,.tsv,.csv" />
      </div>

      <div id="contabDropZone" class="drop-zone">
        Arrastra y suelta el archivo aquí<br/>
        <small style="color:#64748b">o haz clic para seleccionar</small>
      </div>

      <div style="margin-top:12px;border-radius:12px;overflow-x:auto;border:1px solid #1f2937;">
        <table id="contabTable" style="min-width:800px;">
          <thead id="contabHead"></thead>
          <tbody id="contabBody"></tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
        <button id="contabGenerate" type="button">Generar Archivo Contabilizacion Zeus</button>
        <span id="contabStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>
    </section>

    <!-- Artículos -->
    <section id="articulos" class="card hidden">
      <h2>Configuración de Artículos</h2>
      <div style="overflow:auto">
        <table id="articulosTable">
          <thead>
            <tr>
              <th>Codigo de producto Simphony</th>
              <th>Nombre de producto Simphony</th>
              <th>Codigo de articulo Zeus</th>
              <th>Centro de Costo Zeus</th>
              <th>Codigo Bodega Zeus</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="articulosAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="articulosSave" type="button">Guardar</button>
        <span id="articulosStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>
    </section>
  </div>

  <script>
  // === Supabase access helpers ===
  // Guardamos TODA la tabla de cuentas contables en UNA sola fila
  // en la tabla 'contabilidad_cuentas' con id = 1.
  // Estructura esperada en Supabase (Postgres):
  //   CREATE TABLE public.contabilidad_cuentas (
  //     id integer primary key,
  //     updated_at timestamptz,
  //     rows jsonb
  //   );

  let supa = null;
  // === HARDCODED SUPABASE CREDENTIALS ===
  const SUPABASE_URL  = "https://veztzwgrblvdpuzdhtor.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlenR6d2dyYmx2ZHB1emRodG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjY4MTcsImV4cCI6MjA3NzYwMjgxN30.2XaJ5YQQEZmihJF7zFEGv1QJ-z7RmAcPIHf4Hl1qnHk";

  async function initSupabaseIfNeeded(){
    if (supa) return supa;

    // 1) Si ya hay un cliente global, úsalo
    if (window.supabaseClient) {
      supa = window.supabaseClient;
      return supa;
    }

    // 2) Crear cliente con credenciales hardcodeadas
    if (typeof window.supabase !== 'undefined'){
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      supa = window.supabaseClient;
      return supa;
    }

    console.warn('Supabase SDK no detectado o falta configuración.');
    throw new Error('Supabase SDK no inicializado');
  }

  async function saveCuentasToSupabase(rows){
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('contabilidad_cuentas').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadCuentasFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('contabilidad_cuentas')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para ARTÍCULOS ===
  async function saveArticulosToSupabase(rows){
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('articulos_config').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadArticulosFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('articulos_config')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error;
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para CONFIGURACIÓN GENERAL ===
async function saveGeneralToSupabase(data){
  const client = await initSupabaseIfNeeded();
  const nowIso = new Date().toISOString();
  const payload = [{ id: 1, updated_at: nowIso, data }];
  const { error } = await client.from('config_general').upsert(payload, { onConflict: 'id' });
  if (error) throw error;
  return { updated_at: nowIso };
}

async function loadGeneralFromSupabase(){
  const client = await initSupabaseIfNeeded();
  const { data, error } = await client
    .from('config_general')
    .select('data, updated_at')
    .eq('id', 1)
    .maybeSingle();
  if (error && error.code !== 'PGRST116') throw error;
  if (!data) return { data: null, updated_at: null };
  return { data: data.data || null, updated_at: data.updated_at || null };
}
    
  // MAIN APP SCRIPT
  document.addEventListener('DOMContentLoaded', () => {
    // ======== CONSTANTES (evita TDZ) ========
    const CUENTAS_KEY  = 'opera_zeus_cuentas_contables_v2';
    const CUENTAS_COLS = [
      'Codigo de Concepto Opera', 'Nombre Concepto Opera', 'Cuenta Contable Zeus', 'Centro de costo', 'BU', 'Libro', 'Auxiliar Abierto', 'Moneda', 'Banco', 'Plaza'
    ];

    const ARTICULOS_KEY  = 'opera_zeus_articulos_v1';
    const ARTICULOS_COLS = [
      'Codigo de producto Simphony', 'Nombre de producto Simphony', 'Codigo de articulo Zeus', 'Centro de Costo Zeus', 'Codigo Bodega Zeus'
    ];

    // Columnas esperadas del archivo de Contabilización (tab separado)
    const CONTAB_COLS = [
      'Fecha','Codigo_Cargo_Opera','Nombre_Cargo_Opera','Monto_Cargo','Nombre_Cliente','ID_Cliente','Telefono_Cliente','Direccion_Cliente','email_Cliente','Ciudad_Cliente','Pais_Cliente','Col_M','Col_N','Col_O','Factura','Col_P','Col_Q','Tipo_Documento_Cliente','Tipo_Factura','Vencimiento_Factura','Col_U','Folio','Col_W'
    ];

    // memoria en runtime para las filas cargadas de Contabilización
    let contabRows = [];

    // ======== CUENTAS ========
    function getCuentasTableData(){
      const rows = [];
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas totalmente vacías
        const obj = {};
        CUENTAS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderCuentasTable(data){
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        CUENTAS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      const rows = getCuentasTableData();
      localStorage.setItem(CUENTAS_KEY, JSON.stringify(rows)); // backup offline
      try {
        const res = await saveCuentasToSupabase(rows);
        if (st) st.textContent = 'Guardado en Supabase (' + rows.length + ' filas)';
        if (tsLabel && res && res.updated_at) tsLabel.textContent = formatTimestamp(res.updated_at);
      } catch (e) {
        console.error('Error guardando en Supabase:', e);
        if (st) st.textContent = 'Guardado local (' + rows.length + ' filas). Supabase no está disponible.';
      }
    }

    async function loadCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      try{
        let rows = [];
        let updated_at = null;
        try {
          const res = await loadCuentasFromSupabase();
          rows = res.rows; updated_at = res.updated_at;
        } catch (_e) {
          const rawLocal = localStorage.getItem(CUENTAS_KEY);
          rows = rawLocal ? JSON.parse(rawLocal) : [];
          updated_at = null;
        }
        renderCuentasTable(rows);
        if (st) st.textContent = rows.length ? 'Configuración cargada' : '';
        if (tsLabel) tsLabel.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
      } catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
    }


    // ======== CONFIGURACIÓN GENERAL ========
const GENERAL_KEY = 'opera_zeus_config_general_v1';

function sanitizeDigits(str){ return (str||'').replace(/\D+/g,''); }
function sanitizeAlnum(str){ return (str||'').replace(/[^a-zA-Z0-9]+/g,''); }

async function saveGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');

  const cuentaH = sanitizeDigits(document.getElementById('inpCuentaHuespedes')?.value);
  const codVend = sanitizeAlnum(document.getElementById('inpCodVendedor')?.value);
  const cuentaC = sanitizeDigits(document.getElementById('inpCuentaPorCobrar')?.value);

  const obj = {
    cuenta_saldo_huespedes_en_casa: cuentaH || '',
    codigo_vendedor_default: codVend || '',
    cuenta_por_cobrar_default: cuentaC || ''
  };

  // Backup local
  localStorage.setItem(GENERAL_KEY, JSON.stringify(obj));

  try{
    const res = await saveGeneralToSupabase(obj);
    if (st) st.textContent = 'Guardado en Supabase';
    if (ts && res?.updated_at) ts.textContent = formatTimestamp(res.updated_at);
  }catch(e){
    console.error('Error guardando Configuración General en Supabase:', e);
    if (st) st.textContent = 'Guardado local. Supabase no está disponible.';
  }
}

async function loadGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');
  try{
    let data = null, updated_at = null;
    try{
      const res = await loadGeneralFromSupabase();
      data = res.data; updated_at = res.updated_at;
    }catch(_e){
      const raw = localStorage.getItem(GENERAL_KEY);
      data = raw ? JSON.parse(raw) : null;
    }

    if (data){
      const inpH = document.getElementById('inpCuentaHuespedes');
      const inpV = document.getElementById('inpCodVendedor');
      const inpC = document.getElementById('inpCuentaPorCobrar');
      if (inpH) inpH.value = sanitizeDigits(data.cuenta_saldo_huespedes_en_casa || '');
      if (inpV) inpV.value = sanitizeAlnum(data.codigo_vendedor_default || '');
      if (inpC) inpC.value = sanitizeDigits(data.cuenta_por_cobrar_default || '');
      if (st) st.textContent = 'Configuración cargada';
      if (ts) ts.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
    } else {
      if (st) st.textContent = '';
      if (ts) ts.textContent = '(sin publicar)';
    }
  }catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
}

function initGeneralPage(){
  const h = document.getElementById('inpCuentaHuespedes');
  const v = document.getElementById('inpCodVendedor');
  const c = document.getElementById('inpCuentaPorCobrar');
  if (h && !h._bound){ h.addEventListener('input', () => { h.value = sanitizeDigits(h.value); }); h._bound = true; }
  if (v && !v._bound){ v.addEventListener('input', () => { v.value = sanitizeAlnum(v.value); }); v._bound = true; }
  if (c && !c._bound){ c.addEventListener('input', () => { c.value = sanitizeDigits(c.value); }); c._bound = true; }
  const btn = document.getElementById('generalSave');
  if (btn && !btn._bound){ btn.addEventListener('click', saveGeneralConfig); btn._bound = true; }
}


    
    // ======== ARTÍCULOS ========
    function getArticulosTableData(){
      const rows = [];
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas vacías
        const obj = {};
        ARTICULOS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderArticulosTable(data){
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        ARTICULOS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        const rows = getArticulosTableData();
        // Evita borrar datos remotos: si no hay filas válidas, no escribas en Supabase
        if (!rows || rows.length === 0){
          // Mantén backup local, pero NO sobrescribas remoto con []
          localStorage.setItem(ARTICULOS_KEY, JSON.stringify([]));
          if (status) status.textContent = 'No hay filas para guardar. Se mantiene el contenido de Supabase sin cambios.';
          return false;
        }
        // backup local siempre
        localStorage.setItem(ARTICULOS_KEY, JSON.stringify(rows));
        // intenta Supabase
        const res = await saveArticulosToSupabase(rows);
        if (status) status.textContent = 'Guardado en Supabase ('+ rows.length +' fila(s))' + (res?.updated_at ? ' • '+formatTimestamp(res.updated_at) : '');
        return true;
      }catch(e){
        console.error('Error guardando artículos en Supabase:', e);
        const rows = getArticulosTableData();
        if (status) status.textContent = 'Guardado local ('+ rows.length +' fila(s)). Supabase no está disponible.';
        return false;
      }
    }

    async function loadArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        let rows = [];
        try {
          const res = await loadArticulosFromSupabase();
          rows = res.rows;
          if (status) status.textContent = rows.length ? 'Configuración cargada desde Supabase' : '';
        } catch (_e){
          const raw = localStorage.getItem(ARTICULOS_KEY);
          rows = raw ? JSON.parse(raw) : [];
          if (status) status.textContent = rows.length ? 'Configuración cargada (local)' : '';
        }
        renderArticulosTable(rows);
      }catch(e){ if (status) status.textContent = 'No se pudo cargar: ' + e.message; }
    }

    // ======== CONTABILIZACIÓN (TSV/TXT) ========
    function parseTSV(text){
      // Normaliza saltos de línea (CRLF/CR -> LF) y descarta líneas totalmente vacías
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== '');
      const parsed = [];
      for (const line of lines){
        const parts = line.split("\t");
        const obj = {};
        CONTAB_COLS.forEach((col, idx) => { obj[col] = (parts[idx] ?? '').trim(); });
        parsed.push(obj);
      }
      return parsed;
    }

    function renderContabTable(rows){
      const thead = document.getElementById('contabHead');
      const tbody = document.getElementById('contabBody');
      if (!thead || !tbody) return;
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if (!rows || !rows.length){ thead.innerHTML = '<tr><th>Sin datos</th></tr>'; return; }
      thead.innerHTML = '<tr>' + CONTAB_COLS.map(c => `<th>${c}</th>`).join('') + '</tr>';
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        CONTAB_COLS.forEach(c => { const td = document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function initContabilizacionPage(){
      const fileInput = document.getElementById('contabFile');
      const dz        = document.getElementById('contabDropZone');
      const status    = document.getElementById('contabStatus');
      const genBtn    = document.getElementById('contabGenerate');

      async function handleFile(file){
        if (!file) return;
        try { const text = await file.text(); contabRows = parseTSV(text); renderContabTable(contabRows); if (status) status.textContent = 'Cargadas ' + contabRows.length + ' fila(s)'; }
        catch (err){ if (status) status.textContent = 'Error leyendo archivo: ' + err.message; }
      }

      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', (e) => { const file = e.target.files?.[0]; handleFile(file); });
        fileInput._bound = true;
      }

      if (dz && !dz._bound){
        dz.addEventListener('click', () => { fileInput?.click(); });
        dz.addEventListener('dragover', (ev) => { ev.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', () => { dz.classList.remove('dragover'); });
        dz.addEventListener('drop', (ev) => { ev.preventDefault(); dz.classList.remove('dragover'); const file = ev.dataTransfer?.files?.[0]; handleFile(file); });
        dz._bound = true;
      }

      if (genBtn && !genBtn._bound){
        genBtn.addEventListener('click', () => {
          const rowsCount = contabRows.length || 0;
          console.log('Generar Archivo Contabilizacion Zeus - filas:', rowsCount, contabRows);
          if (status) status.textContent = 'Generado archivo (simulado) con ' + rowsCount + ' fila(s).';
          // TODO: definir formato final (descarga .txt/.csv ó envío a API)
        });
        genBtn._bound = true;
      }
    }

    // ======== UTILIDADES GENERALES ========
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function formatTimestamp(iso){
      if (!iso) return '(sin publicar)';
      const d = new Date(iso); if (isNaN(d.getTime())) return iso;
      const yyyy = d.getUTCFullYear(); const mm = pad2(d.getUTCMonth()+1); const dd = pad2(d.getUTCDate());
      const hh = pad2(d.getUTCHours()); const mi = pad2(d.getUTCMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi} UTC`;
    }

    // ======== PARSER XML (Ventas) ========
    const parseText = (node, sel) => (node.querySelector(sel)?.textContent ?? '').trim();
    const parseAttr = (node, name, fallback='') => (node.getAttribute(name) ?? fallback);

    function buildBillsRows(xml){
      const bills = Array.from(xml.querySelectorAll('bill'));
      return bills.map(bill => {
        const resInfo = bill.querySelector('reservation_info');
        const extInfo = bill.querySelector('external_fiscal_info');
        return {
          customer_internal_id: parseAttr(bill, 'customer_internal_id'),
          bill_no: parseText(bill, 'bill_no'),
          bill_type: parseText(bill, 'bill_type'),
          status: parseText(bill, 'status'),
          total_amount: parseText(bill, 'total_amount'),
          name_tax_type: parseText(bill, 'name_tax_type'),
          invoice_no: parseText(bill, 'invoice_no'),
          guest_internal_id: parseText(bill, 'guest_internal_id'),
          confirmation_no: resInfo ? parseText(resInfo, 'confirmation_no') : '',
          arrival_date: resInfo ? parseText(resInfo, 'arrival_date') : '',
          departure_date: resInfo ? parseText(resInfo, 'departure_date') : '',
          guest_name: resInfo ? parseText(resInfo, 'guest_name') : '',
          fiscal_bill_no: extInfo ? parseText(extInfo, 'fiscal_bill_no') : ''
        };
      });
    }

    function buildTransactionsRows(xml){
      const rows = [];
      xml.querySelectorAll('bill').forEach(bill => {
        const billNo = parseText(bill, 'bill_no');
        const guest = bill.querySelector('reservation_info > guest_name')?.textContent?.trim() || '';
        bill.querySelectorAll('bill_detail > transaction').forEach(trx => {
          rows.push({
            bill_no: billNo,
            guest_name: guest,
            trx_no: parseAttr(trx, 'trx_no'),
            trx_no_added_by: parseAttr(trx, 'trx_no_added_by', ''),
            trx_code: parseText(trx, 'trx_code'),
            trx_date: parseText(trx, 'trx_date'),
            cheque_number: parseText(trx, 'cheque_number'),
            net_amount: parseText(trx, 'net_amount'),
            debit_amount: parseText(trx, 'debit_amount'),
            credit_amount: parseText(trx, 'credit_amount'),
            foreign_currency: parseText(trx, 'foreign_currency'),
            foreign_amount: parseText(trx, 'foreign_amount')
          });
        });
      });
      return rows;
    }

    function renderTable(tableEl, rows){
      const thead = tableEl.querySelector('thead');
      const tbody = tableEl.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if (!rows || !rows.length) { thead.innerHTML = '<tr><th>Sin datos</th></tr>'; return; }
      const cols = Object.keys(rows[0]);
      thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        cols.forEach(c => { const td = document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function initVentasPage(){
      // Pestañas (Facturas / Transacciones)
      document.querySelectorAll('#ventas .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('#ventas .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-target');
        ['#billsTableWrap','#trxTableWrap'].forEach(id => {
          const el = document.querySelector(id); if (!el) return; el.style.display = (id === target) ? 'block' : 'none';
        });
      }));

      // File input XML Opera
      const fileInput = document.getElementById('xmlFile');
      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          const status = document.getElementById('ventasStatus');
          if (!file) return;
          try {
            const text = await file.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'application/xml');
            const err = xml.querySelector('parsererror');
            if (err) throw new Error('XML inválido');
            const billRows = buildBillsRows(xml);
            const trxRows  = buildTransactionsRows(xml);
            renderTable(document.getElementById('billsTable'), billRows);
            renderTable(document.getElementById('trxTable'),  trxRows);
            if (status) status.textContent = `Cargadas ${billRows.length} factura(s) y ${trxRows.length} transacción(es)`;
          } catch (ex){ if (status) status.textContent = 'Error: ' + ex.message; }
        });
        fileInput._bound = true;
      }
    }

    // ======== NAV / EVENTOS ========
    const menuItems = document.querySelectorAll('.menu-item');

    function showSection(id){
      document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden')); // Oculta todo
      const el = document.getElementById(id); if (el) el.classList.remove('hidden');    // Muestra
      if (id === 'configgeneral')  { initGeneralPage(); loadGeneralConfig(); }
      if (id === 'cuentas')          loadCuentasConfig();
      if (id === 'articulos')        loadArticulosConfig();
      if (id === 'ventas')           initVentasPage();
      if (id === 'contabilizacion')  initContabilizacionPage();
    }

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const target = item.getAttribute('data-section');
        showSection(target);
      });
    });

    // Botones cuentas contables
    document.getElementById('cuentasSave')?.addEventListener('click', saveCuentasConfig);
    document.getElementById('cuentasAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#cuentasTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      CUENTAS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // Botones artículos
    document.getElementById('articulosSave')?.addEventListener('click', saveArticulosConfig);
    document.getElementById('articulosAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#articulosTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      ARTICULOS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // ======== INICIALIZACIÓN POR DEFECTO ========
    showSection('cuentas');
    document.querySelector('.menu-item[data-section="cuentas"]').classList.add('active');

    // ======== TESTS ========
    (function runSmokeTests(){
      try {
        // Estructura básica esperada
        console.assert(Array.isArray(CUENTAS_COLS) && CUENTAS_COLS.length === 10, 'CUENTAS_COLS debe tener 10 columnas');
        console.assert(Array.isArray(ARTICULOS_COLS) && ARTICULOS_COLS.length === 5,  'ARTICULOS_COLS debe tener 5 columnas');
        console.assert(Array.isArray(CONTAB_COLS)  && CONTAB_COLS.length === 23, 'CONTAB_COLS debe tener 23 columnas');

        // Test de persistencia local para Artículos
        const keyTest = ARTICULOS_KEY + '_test';
        const sample = [{
          'Codigo de producto Simphony': 'P001',
          'Nombre de producto Simphony': 'Producto Demo',
          'Codigo de articulo Zeus': 'Z-100',
          'Centro de Costo Zeus': 'CC01',
          'Codigo Bodega Zeus': 'B01'
        }];
        localStorage.setItem(keyTest, JSON.stringify(sample));
        const got = JSON.parse(localStorage.getItem(keyTest) || '[]');
        console.assert(got.length === 1 && got[0]['Codigo de articulo Zeus'] === 'Z-100', 'Persistencia básica localStorage (artículos)');
        localStorage.removeItem(keyTest);

        // Tests adicionales para parseTSV (LF / CRLF / CR) y mapeo de columnas
        const tsv1 = '2025-11-01\tC001\n2025-11-02\tC002\n';
        const res1 = parseTSV(tsv1);
        console.assert(res1.length === 2, 'parseTSV debe leer 2 filas (LF)');
        console.assert(res1[0]['Fecha'] === '2025-11-01' && res1[0]['Codigo_Cargo_Opera'] === 'C001', 'parseTSV mapea columnas (LF)');

        const tsv2 = '2025-11-03\tC010\r\n2025-11-04\tC020\r\n';
        const res2 = parseTSV(tsv2);
        console.assert(res2.length === 2, 'parseTSV debe leer 2 filas (CRLF)');
        console.assert(res2[1]['Fecha'] === '2025-11-04' && res2[1]['Codigo_Cargo_Opera'] === 'C020', 'parseTSV mapea columnas (CRLF)');

        const tsv3 = '2025-11-05\tC100\r2025-11-06\tC200\r';
        const res3 = parseTSV(tsv3);
        console.assert(res3.length === 2, 'parseTSV debe leer 2 filas (CR)');
        console.assert(res3[0]['Fecha'] === '2025-11-05' && res3[0]['Codigo_Cargo_Opera'] === 'C100', 'parseTSV mapea columnas (CR)');

        // Test Col_O insertado entre Col_N y Factura
        const tsv4 = '2025-12-01\tC777\tCargo X\t1500\tJuan Perez\tID777\t3000000000\tCalle 123\tjuan@x.com\tBogotá\tCO\tMVAL\tNVAL\tOVAL\tF001\tPVAL\tQVAL\tCC\tFAC\t2025-12-10\tUVAL\tFOLIOX\tWVAL\n';
        const res4 = parseTSV(tsv4);
        console.assert(res4.length === 1, 'parseTSV debe leer 1 fila (Col_O)');
        console.assert(res4[0]['Col_O'] === 'OVAL' && res4[0]['Factura'] === 'F001', 'Col_O correctamente mapeada y en orden');

        // Tests de UI básicos
        console.assert(document.getElementById('cuentasTable') instanceof HTMLTableElement, 'Tabla de cuentas existe');
        console.assert(document.getElementById('contabTable') instanceof HTMLTableElement, 'Tabla de contabilización existe');

        console.assert(typeof initSupabaseIfNeeded === 'function', 'initSupabaseIfNeeded debe existir');
        console.assert(typeof saveCuentasToSupabase === 'function', 'saveCuentasToSupabase debe existir');
        console.assert(typeof loadCuentasFromSupabase === 'function', 'loadCuentasFromSupabase debe existir');

        // Nuevos helpers de artículos
        console.assert(typeof saveArticulosToSupabase === 'function', 'saveArticulosToSupabase debe existir');
        console.assert(typeof loadArticulosFromSupabase === 'function', 'loadArticulosFromSupabase debe existir');

        console.assert(typeof saveGeneralToSupabase === 'function', 'saveGeneralToSupabase debe existir');
        console.assert(typeof loadGeneralFromSupabase === 'function', 'loadGeneralFromSupabase debe existir');
        console.assert(sanitizeDigits('A1B2C3') === '123', 'sanitizeDigits');
        console.assert(sanitizeAlnum('A-1_B 2!') === 'A1B2', 'sanitizeAlnum');

        
        // Extra: smoke test de invocación segura (no debe lanzar)
        (async ()=>{ try { const r = await saveArticulosConfig(); console.assert(r === false, 'saveArticulosConfig vacío debe retornar false y no upsert'); } catch (e) { console.error('saveArticulosConfig lanzó excepción inesperada', e); } })();

        console.log('%cSmoke tests OK','color:#22c55e');
      } catch (e) { console.error('Smoke tests FAILED', e); }
    })();
  }); // FIN DOMContentLoaded
  </script>
</body>
</html>
