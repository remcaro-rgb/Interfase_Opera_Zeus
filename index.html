<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interfaz Opera - Zeus</title>
  <style>
    body {margin: 0; font-family: Arial, sans-serif; background-color: #0f172a; color: #e5e7eb; display: flex;}
    .sidebar {width: 260px; background-color: #111827; border-right: 1px solid #1f2937; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; padding-top: 24px;}
    .sidebar h2 {color: #22c55e; font-size: 18px; margin: 0 0 20px 20px;}
    .menu-item {padding: 12px 20px; color: #94a3b8; text-decoration: none; display: block; transition: background 0.2s; cursor: pointer;}
    .menu-item:hover, .menu-item.active {background-color: #1e293b; color: #22c55e;}
    .content {margin-left: 260px; padding: 20px; width: calc(100% - 260px);}    
    .card {background: #111827; padding: 20px; border-radius: 10px; border: 1px solid #1f2937; margin-bottom: 20px;}
    input, button {border-radius: 6px; border: none; padding: 8px 10px; margin: 5px 0; font-size: 14px;}
    input {width: 100%;}
    button {background-color: #22c55e; color: white; cursor: pointer;}
    button:hover {background-color: #16a34a;}
    table {width: 100%; border-collapse: collapse; color: #e5e7eb; margin-top: 10px;}
    table th, table td {border: 1px solid #1f2937; padding: 8px;}
    table th {background-color: #1e293b;}
    .hidden {display: none;}
    .editable:focus {outline: 2px solid #38bdf8;}
    .drop-zone {margin-top:10px;border:2px dashed #334155;border-radius:10px;padding:20px;text-align:center;color:#94a3b8;background-color:#1e293b;cursor:pointer;}
    .drop-zone.dragover {background-color:#334155;color:#fff;}
  </style>
  <!-- Supabase CDN (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Menú</h2>
    <div class="menu-item" data-section="usuarios" style="display:none">Usuarios</div>
    <div class="menu-item" data-section="clientes" style="display:none">Configuración de Clientes</div>
    <div class="menu-item" data-section="configgeneral">Configuracion General</div>
    <div class="menu-item" data-section="cuentas">Configuración de Cuentas Contables</div>
    <div class="menu-item" data-section="articulos">Configuración de Artículos</div>
    <div class="menu-item" data-section="ventas" style="display:none">Contabilizar Ventas</div>
    <div class="menu-item" data-section="contabilizacion">Contabilización</div>
    <div class="menu-item" data-section="inventario">Generar Archivo de Inventario</div>
    <div class="menu-item" data-section="login" style="display:none">Iniciar Sesión</div>
  </div>

  <div class="content">
    <h1>Interfaz Opera - Zeus v1.24</h1>

    <!-- Configuración General -->
<section id="configgeneral" class="card hidden">
  <h2>Configuración General</h2>

  <div style="display:grid;grid-template-columns:320px 1fr;gap:12px;align-items:center;">
    <label for="inpCuentaHuespedes" style="color:#94a3b8;">Cuenta Saldo Huéspedes en Casa</label>
    <input id="inpCuentaHuespedes" type="text" inputmode="numeric" placeholder="Sólo números" />

    <label for="inpCodVendedor" style="color:#94a3b8;">Código de vendedor por defecto para clientes</label>
    <input id="inpCodVendedor" type="text" placeholder="Alfanumérico" />

    <label for="inpCuentaPorCobrar" style="color:#94a3b8;">Cuenta por cobrar por defecto para clientes</label>
    <input id="inpCuentaPorCobrar" type="text" inputmode="numeric" placeholder="Sólo números" />

    <label for="inpFuente" style="color:#94a3b8;">Fuente para contabilizacion</label>
    <input id="inpFuente" type="text" placeholder="Alfanumérico" />
  </div>

  <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
    <button id="generalSave" type="button">Guardar</button>
    <span id="generalStatus" style="margin-left:6px;color:#94a3b8"></span>
  </div>

  <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
    <strong>Última actualización:</strong>
    <span id="generalLastUpdated">(sin publicar)</span>
  </div>
</section>


    <!-- Cuentas Contables -->
    <section id="cuentas" class="card hidden">
      <h2>Configuración de Cuentas Contables</h2>

      <div style="overflow:auto">
        <table id="cuentasTable">
          <thead>
            <tr>
              <th>Codigo de Concepto Opera</th>
              <th>Nombre Concepto Opera</th>
              <th>Cuenta Contable Zeus</th>
              <th>Centro de costo</th>
              <th>BU</th>
              <th>Libro</th>
              <th>Auxiliar Abierto</th>
              <th>Moneda</th>
              <th>Banco</th>
              <th>Plaza</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="cuentasAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="cuentasSave" type="button">Guardar</button>
        <span id="cuentasStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>

      <div style="margin-top:6px;color:#94a3b8;font-size:12px;line-height:1.4;">
        <strong>Última actualización global:</strong>
        <span id="cuentasLastUpdated">(sin publicar)</span>
      </div>
    </section>

    <!-- Contabilización (TSV / TXT) -->
    <section id="contabilizacion" class="card hidden">
      <h2>Contabilización</h2>
      <div class="note" style="color:#94a3b8;margin-bottom:8px">
        Carga un archivo de texto (tab separado) tipo "Cargos_Diarios_Opera.txt" para previsualizarlo.
      </div>

      <div class="row" style="display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;">
        <label for="contabFile" style="color:#94a3b8">Archivo Contabilización</label>
        <input id="contabFile" type="file" accept=".txt,.tsv,.csv" />
      </div>

      <div id="contabDropZone" class="drop-zone">
        Arrastra y suelta el archivo aquí<br/>
        <small style="color:#64748b">o haz clic para seleccionar</small>
      </div>

      <div style="margin-top:12px;border-radius:12px;overflow-x:auto;border:1px solid #1f2937;">
        <table id="contabTable" style="min-width:800px;">
          <thead id="contabHead"></thead>
          <tbody id="contabBody"></tbody>
        </table>
      </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;">
      <button id="contabGenerate" type="button">Generar Archivo Contabilizacion Zeus</button>
      <button id="contabGenerateTerceros" type="button" style="background:#0ea5e9">Generar Archivo Terceros Zeus</button>
      <span id="contabStatus" style="margin-left:6px;color:#94a3b8"></span>
    </div>

    </section>

    <!-- Artículos -->
    <section id="articulos" class="card hidden">
      <h2>Configuración de Artículos</h2>
      <div style="overflow:auto">
        <table id="articulosTable">
          <thead>
            <tr>
              <th>Codigo de producto Simphony</th>
              <th>Nombre de producto Simphony</th>
              <th>Codigo de articulo Zeus</th>
              <th>Centro de Costo Zeus</th>
              <th>Codigo Bodega Zeus</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
              <td contenteditable="true"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;">
        <button id="articulosAddRow" type="button" style="background:#1e293b;border:1px solid #334155">+ Agregar fila</button>
        <button id="articulosSave" type="button">Guardar</button>
        <span id="articulosStatus" style="margin-left:6px;color:#94a3b8"></span>
      </div>
    </section>

        <!-- Inventario / Simphony MID -->
    <section id="inventario" class="card hidden">
      <h2>Actualizar Inventario (Simphony MID)</h2>

      <div class="note" style="color:#94a3b8;margin-bottom:8px">
        Carga el archivo <strong>Simp_RADISSON INDIVIDUALS_YYYY-MM-DD.txt</strong> (pipe <code>|</code> separado).
        Se mostrarán sólo las líneas que comienzan con <strong>MID|</strong>.
      </div>

      <div class="row" style="display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center;">
        <label for="invFile" style="color:#94a3b8">Archivo Simphony (MID)</label>
        <input id="invFile" type="file" accept=".txt" />
      </div>

      <div id="invDropZone" class="drop-zone">
        Arrastra y suelta el archivo aquí<br/>
        <small style="color:#64748b">o haz clic para seleccionar</small>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <input id="invFilterInput" type="text" placeholder="Filtrar por texto..." style="max-width:260px;padding:6px 8px;border-radius:6px;border:none;"/>
        <button id="invDownloadCsv" type="button">Descargar tabla Simphony</button>
        <button id="invGenerateZeus" type="button">Generar Archivo Zeus Inventario</button>
        <span id="invStatus" style="color:#94a3b8"></span>
      </div>

      <div style="margin-top:12px;border-radius:12px;overflow-x:auto;border:1px solid #1f2937;">
        <table id="invTable" style="min-width:800px;">
          <thead id="invHead"></thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button id="invPrevPage" type="button">Anterior</button>
        <button id="invNextPage" type="button">Siguiente</button>
        <span id="invPageInfo" style="color:#94a3b8;"></span>
      </div>
    </section>

  </div>

  <script>
  // === Supabase access helpers ===
  // Guardamos TODA la tabla de cuentas contables en UNA sola fila
  // en la tabla 'contabilidad_cuentas' con id = 1.
  // Estructura esperada en Supabase (Postgres):
  //   CREATE TABLE public.contabilidad_cuentas (
  //     id integer primary key,
  //     updated_at timestamptz,
  //     rows jsonb
  //   );

  let supa = null;
  // === HARDCODED SUPABASE CREDENTIALS ===
  const SUPABASE_URL  = "https://veztzwgrblvdpuzdhtor.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlenR6d2dyYmx2ZHB1emRodG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjY4MTcsImV4cCI6MjA3NzYwMjgxN30.2XaJ5YQQEZmihJF7zFEGv1QJ-z7RmAcPIHf4Hl1qnHk";

  async function initSupabaseIfNeeded(){
    if (supa) return supa;

    // 1) Si ya hay un cliente global, úsalo
    if (window.supabaseClient) {
      supa = window.supabaseClient;
      return supa;
    }

    // 2) Crear cliente con credenciales hardcodeadas
    if (typeof window.supabase !== 'undefined'){
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      supa = window.supabaseClient;
      return supa;
    }

    console.warn('Supabase SDK no detectado o falta configuración.');
    throw new Error('Supabase SDK no inicializado');
  }

  async function saveCuentasToSupabase(rows){https://github.com/remcaro-rgb/Interfase_Opera_Zeus/blob/main/index.html
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('contabilidad_cuentas').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadCuentasFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('contabilidad_cuentas')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para ARTÍCULOS ===
  async function saveArticulosToSupabase(rows){
    const client = await initSupabaseIfNeeded();
    const nowIso = new Date().toISOString();
    const payload = [{ id: 1, updated_at: nowIso, rows }];
    const { error } = await client.from('articulos_config').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
    return { updated_at: nowIso };
  }

  async function loadArticulosFromSupabase(){
    const client = await initSupabaseIfNeeded();
    const { data, error } = await client
      .from('articulos_config')
      .select('rows, updated_at')
      .eq('id', 1)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error;
    if (!data) return { rows: [], updated_at: null };
    return { rows: Array.isArray(data.rows) ? data.rows : [], updated_at: data.updated_at || null };
  }

  // === Supabase helpers para CONFIGURACIÓN GENERAL ===
async function saveGeneralToSupabase(data){
  const client = await initSupabaseIfNeeded();
  const nowIso = new Date().toISOString();
  const payload = [{ id: 1, updated_at: nowIso, data }];
  const { error } = await client.from('config_general').upsert(payload, { onConflict: 'id' });
  if (error) throw error;
  return { updated_at: nowIso };
}

async function loadGeneralFromSupabase(){
  const client = await initSupabaseIfNeeded();
  const { data, error } = await client
    .from('config_general')
    .select('data, updated_at')
    .eq('id', 1)
    .maybeSingle();
  if (error && error.code !== 'PGRST116') throw error;
  if (!data) return { data: null, updated_at: null };
  return { data: data.data || null, updated_at: data.updated_at || null };
}

function parseToNumber(val){
  let s = (val ?? '').toString().trim();
  if (!s) return 0;
  s = s.replace(/[^0-9,.-]/g, '');
  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && hasDot){
    const decPos = Math.max(s.lastIndexOf(','), s.lastIndexOf('.'));
    const intPart = s.slice(0, decPos).replace(/[.,]/g, '');
    const decPart = s.slice(decPos+1).replace(/[.,]/g, '');
    s = intPart + '.' + decPart;
  } else if (hasComma && !hasDot){
    s = s.replace(/\./g, '').replace(',', '.');
  } else {
    s = s.replace(/,/g, '');
  }
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function formatMoneyUSD(n){
  const x = Number(n);
  return Number.isFinite(x)
    ? '$' + x.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
    : '$0.00';
}

// Normalize keys to compare reliably
function normKey(s){
  return (s ?? '')
    .toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // strip accents
    .trim().toLowerCase()
    .replace(/\s+/g,'_')
    .replace(/[^a-z0-9_]/g,'');
}

// Try to read row[col] with fallbacks / aliases
function getRowValue(row, col){
  if (!row) return '';
  if (col in row) return row[col] ?? '';
  const nkCol = normKey(col);
  // exact normalized match
  for (const k of Object.keys(row)){
    if (normKey(k) === nkCol) return row[k] ?? '';
  }
  // aliases for Monto_Cargo
  if (nkCol === 'monto_cargo'){
    const aliases = new Set(['monto_cargo','monto','monto_de_cargo','amount','monto_carg']);
    for (const k of Object.keys(row)){
      if (aliases.has(normKey(k))) return row[k] ?? '';
    }
  }
  return '';
}

// === Supabase helpers para CONFIGURACIÓN GENERAL ===
// Tabla esperada: config_general (id int PK, updated_at timestamptz, data jsonb)
async function loadGeneralFromSupabase(){
  const client = await initSupabaseIfNeeded();
  const { data, error } = await client
    .from('config_general')
    .select('data, updated_at')
    .eq('id', 1)
    .maybeSingle();
  if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows
  if (!data) return { data: null, updated_at: null };
  return { data: data.data || null, updated_at: data.updated_at || null };
}


    
  // MAIN APP SCRIPT
  document.addEventListener('DOMContentLoaded', () => {
    // ======== CONSTANTES (evita TDZ) ========
    const CUENTAS_KEY  = 'opera_zeus_cuentas_contables_v2';
    const CUENTAS_COLS = [
      'Codigo de Concepto Opera', 'Nombre Concepto Opera', 'Cuenta Contable Zeus', 'Centro de costo', 'BU', 'Libro', 'Auxiliar Abierto', 'Moneda', 'Banco', 'Plaza'
    ];

    const ARTICULOS_KEY  = 'opera_zeus_articulos_v1';
    const ARTICULOS_COLS = [
      'Codigo de producto Simphony', 'Nombre de producto Simphony', 'Codigo de articulo Zeus', 'Centro de Costo Zeus', 'Codigo Bodega Zeus'
    ];

    // Columnas esperadas del archivo de Contabilización (tab separado)
const CONTAB_COLS = [
  'Fecha','Codigo_Cargo_Opera','Nombre_Cargo_Opera','Monto_Cargo','Nombre_Cliente','ID_Cliente',
  'Telefono_Cliente','Direccion_Cliente','email_Cliente','Ciudad_Cliente','Pais_Cliente',
  'Col_M','Col_N','Col_O','Factura','Col_P','Col_Q',
  'Tipo_Documento_Cliente','Tipo_Factura','Vencimiento_Factura','Col_U','Folio','Col_W'
];

          // ======== INVENTARIO (Simphony MID) ========
    // Columnas EXACTAS según el layout "Menu Item Sales Records (MID)" de Simphony
    const INV_MID_COLS = [
      'Record Type',
      'Revenue Center Number',
      'Order Type Number',
      'Menu Item Number',
      'Menu Item Name',
      'Price Level',
      'Sales Count',
      'Sales Total',
      'Discount Total',
      'Return Count',
      'Volume',
      'Prep Cost',
      'Menu Item Master Name',
      'Menu Item Master Number',
      'Revenue Center Name',
      'Revenue Center Master Name',
      'Revenue Center Master Number',
      'Menu Item Name2',
      'Menu Item Name2 Master',
'Major Group Name',
'Major Group Number',
'Major Group Master Name',
'Major Group Master Number',
'Family Group Name',
'Family Group Number',
'Family Group Master Name',
'Family Group Master Number',
'Order Type Name',
'Order Type Master Name',
'Order Type Master Number',
'Gross Sales Before Discount',
'Discount Gross VAT',
'Gross Sales After Discount',
'VAT Before Discount',
'Discount VAT',
'VAT After Discount',
'VAT Total',
'Sales Net VAT Before Discount',
'Discount Net VAT',
'Sales Net VAT',
'Order Channel Number',
'Order Channel Name',
'Order Channel Master Number',
'Order Channel Master Name',
'Inclusive Tax Forgiven Total',
'Inclusive Tax Total',
'Sales Net GST'
    ];

    const INV_PAGE_SIZE = 50;

    // Estado en memoria para Inventario (MID)
    let invMidRows = [];          // todas las filas MID
    let invMidFilteredRows = [];  // resultado de filtro de texto (si aplica)
    let invMidPage = 1;

    // Fecha cruda del archivo Simphony (4ta posición de la primera fila del TXT original)
    let zeusInvRawFileDate = '';

    // Mapa de artículos cargado desde Supabase (por "Codigo de producto Simphony")
    let articulosMapBySimphony = null;

    const ZEUS_INV_TEMPLATE_LINE = `1,11,0,2025/10/01,Movimiento Simphony,16,0,0,0,491,01,,0,0,,3,944,,104167,,,,,,,,,,,,,,0,0,0,,0,0,0,0,,0,0,0,,,,0,0,,,,,,,,,`; 
    const ZEUS_INV_TEMPLATE_COLS = ZEUS_INV_TEMPLATE_LINE.split(',');
    
    // Plantilla base (primera fila de SAMPLE_Transac_Temp) para columnas fijas
    const TRANSAC_TEMPLATE_LINE = '202510;11;00NUEVO;2025/10/28;13050502;204725658;R6028285;;;Desglose 12981600;829407;;;;OTR;;;;2025/10/28;;Excel;30/10/25 20:34;061;;;0;;;0;XA;0;Excel;;;;0;0;0;;;0;11';
    const TRANSAC_TEMPLATE_COLS = TRANSAC_TEMPLATE_LINE.split(';');

    // Clave local para configuración general (fuente)
    const GENERAL_KEY = 'opera_zeus_config_general_v1';

    // memoria en runtime para las filas cargadas de Contabilización
    let contabRows = [];

    // ======== CUENTAS ========
    function getCuentasTableData(){
      const rows = [];
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas totalmente vacías
        const obj = {};
        CUENTAS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderCuentasTable(data){
      const tbody = document.querySelector('#cuentasTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        CUENTAS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      const rows = getCuentasTableData();
      localStorage.setItem(CUENTAS_KEY, JSON.stringify(rows)); // backup offline
      try {
        const res = await saveCuentasToSupabase(rows);
        if (st) st.textContent = 'Guardado en Supabase (' + rows.length + ' filas)';
        if (tsLabel && res && res.updated_at) tsLabel.textContent = formatTimestamp(res.updated_at);
      } catch (e) {
        console.error('Error guardando en Supabase:', e);
        if (st) st.textContent = 'Guardado local (' + rows.length + ' filas). Supabase no está disponible.';
      }
    }

    async function loadCuentasConfig(){
      const st = document.getElementById('cuentasStatus');
      const tsLabel = document.getElementById('cuentasLastUpdated');
      try{
        let rows = [];
        let updated_at = null;
        try {
          const res = await loadCuentasFromSupabase();
          rows = res.rows; updated_at = res.updated_at;
        } catch (_e) {
          const rawLocal = localStorage.getItem(CUENTAS_KEY);
          rows = rawLocal ? JSON.parse(rawLocal) : [];
          updated_at = null;
        }
        renderCuentasTable(rows);
        if (st) st.textContent = rows.length ? 'Configuración cargada' : '';
        if (tsLabel) tsLabel.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
      } catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
    }


    // ======== CONFIGURACIÓN GENERAL ========
//const GENERAL_KEY = 'opera_zeus_config_general_v1';

function sanitizeDigits(str){ return (str||'').replace(/\D+/g,''); }
function sanitizeAlnum(str){ return (str||'').replace(/[^a-zA-Z0-9]+/g,''); }

async function saveGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');

  const cuentaH = sanitizeDigits(document.getElementById('inpCuentaHuespedes')?.value);
  const codVend = sanitizeAlnum(document.getElementById('inpCodVendedor')?.value);
  const cuentaC = sanitizeDigits(document.getElementById('inpCuentaPorCobrar')?.value);
  const fuente  = sanitizeAlnum(document.getElementById('inpFuente')?.value);

  const obj = {
    cuenta_saldo_huespedes_en_casa: cuentaH || '',
    codigo_vendedor_default: codVend || '',
    cuenta_por_cobrar_default: cuentaC || '',
    fuente:                    fuente  || ''
  };

  // Backup local
  localStorage.setItem(GENERAL_KEY, JSON.stringify(obj));

  try{
    const res = await saveGeneralToSupabase(obj);
    if (st) st.textContent = 'Guardado en Supabase';
    if (ts && res?.updated_at) ts.textContent = formatTimestamp(res.updated_at);
  }catch(e){
    console.error('Error guardando Configuración General en Supabase:', e);
    if (st) st.textContent = 'Guardado local. Supabase no está disponible.';
  }
}

async function loadGeneralConfig(){
  const st = document.getElementById('generalStatus');
  const ts = document.getElementById('generalLastUpdated');
  try{
    let data = null, updated_at = null;
    try{
      const res = await loadGeneralFromSupabase();
      data = res.data; updated_at = res.updated_at;
    }catch(_e){
      const raw = localStorage.getItem(GENERAL_KEY);
      data = raw ? JSON.parse(raw) : null;
    }

    if (data){
      const inpH = document.getElementById('inpCuentaHuespedes');
      const inpV = document.getElementById('inpCodVendedor');
      const inpC = document.getElementById('inpCuentaPorCobrar');
      const inpF = document.getElementById('inpFuente');

      if (inpH) inpH.value = sanitizeDigits(data.cuenta_saldo_huespedes_en_casa || '');
      if (inpV) inpV.value = sanitizeAlnum(data.codigo_vendedor_default || '');
      if (inpC) inpC.value = sanitizeDigits(data.cuenta_por_cobrar_default || '');
      if (inpF) inpF.value = sanitizeAlnum(data.fuente || '');

      if (st) st.textContent = 'Configuración cargada';
      if (ts) ts.textContent = updated_at ? formatTimestamp(updated_at) : '(sin publicar)';
    } else {
      if (st) st.textContent = '';
      if (ts) ts.textContent = '(sin publicar)';
    }
  }catch(e){ if (st) st.textContent = 'No se pudo cargar: ' + e.message; }
}

function initGeneralPage(){
  const h = document.getElementById('inpCuentaHuespedes');
  const v = document.getElementById('inpCodVendedor');
  const c = document.getElementById('inpCuentaPorCobrar');
  const f = document.getElementById('inpFuente');

  if (h && !h._bound){ h.addEventListener('input', () => { h.value = sanitizeDigits(h.value); }); h._bound = true; }
  if (v && !v._bound){ v.addEventListener('input', () => { v.value = sanitizeAlnum(v.value); }); v._bound = true; }
  if (c && !c._bound){ c.addEventListener('input', () => { c.value = sanitizeDigits(c.value); }); c._bound = true; }
  if (f && !f._bound){f.addEventListener('input', () => { f.value = sanitizeAlnum(f.value); }); f._bound = true;}

  const btn = document.getElementById('generalSave');
  if (btn && !btn._bound){ btn.addEventListener('click', saveGeneralConfig); btn._bound = true; }
}


    
    // ======== ARTÍCULOS ========
    function getArticulosTableData(){
      const rows = [];
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr => {
        const cells = Array.from(tr.querySelectorAll('td'));
        if (cells.every(c => !c.textContent.trim())) return; // omite filas vacías
        const obj = {};
        ARTICULOS_COLS.forEach((col, i) => obj[col] = (cells[i]?.textContent || '').trim());
        rows.push(obj);
      });
      return rows;
    }

    function renderArticulosTable(data){
      const tbody = document.querySelector('#articulosTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = (Array.isArray(data) && data.length) ? data : [{}];
      rows.forEach(row => {
        const tr = document.createElement('tr');
        ARTICULOS_COLS.forEach(col => {
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.textContent = row[col] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function saveArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        const rows = getArticulosTableData();
        // Evita borrar datos remotos: si no hay filas válidas, no escribas en Supabase
        if (!rows || rows.length === 0){
          // Mantén backup local, pero NO sobrescribas remoto con []
          localStorage.setItem(ARTICULOS_KEY, JSON.stringify([]));
          if (status) status.textContent = 'No hay filas para guardar. Se mantiene el contenido de Supabase sin cambios.';
          return false;
        }
        // backup local siempre
        localStorage.setItem(ARTICULOS_KEY, JSON.stringify(rows));
        // intenta Supabase
        const res = await saveArticulosToSupabase(rows);
        if (status) status.textContent = 'Guardado en Supabase ('+ rows.length +' fila(s))' + (res?.updated_at ? ' • '+formatTimestamp(res.updated_at) : '');
        return true;
      }catch(e){
        console.error('Error guardando artículos en Supabase:', e);
        const rows = getArticulosTableData();
        if (status) status.textContent = 'Guardado local ('+ rows.length +' fila(s)). Supabase no está disponible.';
        return false;
      }
    }

    async function loadArticulosConfig(){
      const status = document.getElementById('articulosStatus');
      try{
        let rows = [];
        try {
          const res = await loadArticulosFromSupabase();
          rows = res.rows;
          if (status) status.textContent = rows.length ? 'Configuración cargada desde Supabase' : '';
        } catch (_e){
          const raw = localStorage.getItem(ARTICULOS_KEY);
          rows = raw ? JSON.parse(raw) : [];
          if (status) status.textContent = rows.length ? 'Configuración cargada (local)' : '';
        }
        renderArticulosTable(rows);
      }catch(e){ if (status) status.textContent = 'No se pudo cargar: ' + e.message; }
    }

        function toDateYYYYMMDDSlash(raw){
      if (!raw) return '';
      const s = raw.toString().trim();
      // 20251028 -> 2025/10/28
      if (/^\d{8}$/.test(s)){
        return s.slice(0,4) + '/' + s.slice(4,6) + '/' + s.slice(6,8);
      }
      // 2025-10-28 -> 2025/10/28
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)){
        return s.replace(/-/g, '/');
      }
      // 2025/10/28 -> igual
      if (/^\d{4}\/\d{2}\/\d{2}$/.test(s)){
        return s;
      }
      return s; // fallback
    }

    
    // ======== CONTABILIZACIÓN (TSV/TXT) ========
    function parseTSV(text){
      // Normaliza saltos de línea (CRLF/CR -> LF) y descarta líneas totalmente vacías
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.trim() !== '');
      const parsed = [];
      for (const line of lines){
        const parts = line.split("\t");
        const obj = {};
        CONTAB_COLS.forEach((col, idx) => { obj[col] = (parts[idx] ?? '').trim(); });
        parsed.push(obj);
      }
      return parsed;
    }

function renderContabTable(rows){
  const thead = document.getElementById('contabHead');
  const tbody = document.getElementById('contabBody');
  if (!thead || !tbody) return;

  // Clear
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // Header (DOM, no innerHTML)
  const trHead = document.createElement('tr');
  CONTAB_COLS.forEach(label => {
    const th = document.createElement('th');
    th.textContent = label;          // <= ensures "Monto_Cargo" always visible
    th.style.whiteSpace = 'nowrap';  // keep header readable
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // Body
  if (!rows || !rows.length) return;

  const frag = document.createDocumentFragment();
  rows.forEach(row => {
    const tr = document.createElement('tr');
    CONTAB_COLS.forEach(col => {
      const td = document.createElement('td');
      const raw = (col in row) ? row[col] : '';

      if (col === 'Monto_Cargo') {
        td.textContent = formatMoneyUSD(parseToNumber(raw));
      } else {
        td.textContent = raw ?? '';
      }
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}




    function initContabilizacionPage(){
      const fileInput = document.getElementById('contabFile');
      const dz        = document.getElementById('contabDropZone');
      const status    = document.getElementById('contabStatus');
      const genBtn    = document.getElementById('contabGenerate');
      const tercerosBtn = document.getElementById('contabGenerateTerceros');

      async function handleFile(file){
        if (!file) return;
        try {
          const text = await file.text();
          contabRows = parseTSV(text);
          renderContabTable(contabRows);
          if (status) status.textContent = 'Cargadas ' + contabRows.length + ' fila(s)';
        } catch (err){
          console.error(err);
          if (status) status.textContent = 'Error leyendo archivo: ' + err.message;
        }
      }

      // Input file
      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          handleFile(file);
        });
        fileInput._bound = true;
      }

      // Drag & drop
      if (dz && !dz._bound){
        dz.addEventListener('click', () => {
          if (fileInput) fileInput.click();
        });
        dz.addEventListener('dragover', (ev) => {
          ev.preventDefault();
          dz.classList.add('dragover');
        });
        dz.addEventListener('dragleave', () => {
          dz.classList.remove('dragover');
        });
        dz.addEventListener('drop', (ev) => {
          ev.preventDefault();
          dz.classList.remove('dragover');
          const file = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
          handleFile(file);
        });
        dz._bound = true;
      }

      // Generar archivos Zeus
      if (genBtn && !genBtn._bound){
        genBtn.addEventListener('click', async () => {
          try {
            const rowsCount = contabRows.length || 0;
            if (!rowsCount){
              if (status) status.textContent = 'No hay filas para generar.';
              return;
            }

            // === 1) CONFIG_GENERAL: fuente y cuenta_huespedes ===
            let fuente = '';
            let cuentaHuesp = '';
            try {
              const resGen = await loadGeneralFromSupabase();
              if (resGen && resGen.data){
                if (resGen.data.fuente){
                  fuente = String(resGen.data.fuente).trim();
                }
                if (resGen.data.cuenta_saldo_huespedes_en_casa){
                  cuentaHuesp = String(resGen.data.cuenta_saldo_huespedes_en_casa).trim();
                }
              }
            } catch (e) {
              // Fallback localStorage
              try {
                const raw = localStorage.getItem(GENERAL_KEY);
                if (raw){
                  const obj = JSON.parse(raw);
                  if (obj.fuente) fuente = String(obj.fuente).trim();
                  if (obj.cuenta_saldo_huespedes_en_casa){
                    cuentaHuesp = String(obj.cuenta_saldo_huespedes_en_casa).trim();
                  }
                }
              } catch (_e) {}
            }

            // === 2) Cuentas contables ===
            let cuentasRows = [];
            try {
              const resC = await loadCuentasFromSupabase();
              cuentasRows = resC.rows || [];
            } catch (e) {
              try {
                const raw = localStorage.getItem(CUENTAS_KEY);
                if (raw) cuentasRows = JSON.parse(raw);
              } catch (_e) {}
              if (!cuentasRows || !cuentasRows.length){
                cuentasRows = getCuentasTableData();
              }
            }

            const cuentasMap = {};
            if (Array.isArray(cuentasRows)){
              cuentasRows.forEach((r) => {
                const code = (r['Codigo de Concepto Opera'] || '').toString().trim();
                if (code) cuentasMap[code] = r;
              });
            }

            // === 3) Construir Transac_Temp_Zeus ===
            const lines = [];
            let sumPos = 0;
            let sumNeg = 0;

            contabRows.forEach((src) => {
              const fechaRaw    = (src['Fecha'] || '').toString().trim();
              const fechaDigits = fechaRaw.replace(/[^0-9]/g, '');
              const fecha6      = fechaDigits.slice(0, 6);
              const fechaYMD    = toDateYYYYMMDDSlash(fechaRaw);

              const codCargo    = (src['Codigo_Cargo_Opera'] || '').toString().trim();
              
              
              // ⬇️ NUEVO: saltar filas con Codigo_Cargo_Opera = 9991
              if (codCargo === '9991') {
                return; // no genera ninguna de las 2 filas de Transac para este registro
              }
              
              const cuentaCfg   = cuentasMap[codCargo] || {};
              const cuentaCont  = (cuentaCfg['Cuenta Contable Zeus'] || '').toString().trim();
              const centroCosto = (cuentaCfg['Centro de costo']       || '').toString().trim();

              const idCliente   = (src['ID_Cliente'] || '').toString().trim();
              const folio       = (src['Folio']      || '').toString().trim();
            

              //if account starts with "11" assign "EFE" as pay method
              //const tipoFactura =  (src['Tipo_Factura']       || '').toString().trim();
              const codMoneda   = (cuentaCfg['Moneda']).toString().trim();
              const tipoFactura = (cuentaCont.startsWith('11')) ? codMoneda : ((src['Tipo_Factura']       || '').toString().trim());
              
              //const nombreCargo = (src['Nombre_Cargo_Opera'] || '').toString().trim();

              const nombreCargo = (src['Nombre_Cargo_Opera'] || '#' || codMoneda || '-' || src['Col_U'] || '').toString().trim();
              
          
                         
              const numFactura  = (src['Factura']            || '').toString().trim();
              const vencRaw     = (src['Vencimiento_Factura'] || '').toString().trim();
              const vencYMD     = toDateYYYYMMDDSlash(vencRaw);

              const monto       = parseToNumber(src['Monto_Cargo']);

              //Define el signo del monto
              //const debeNeg     = cuentaCont.startsWith('41') || cuentaCont.startsWith('11') || cuentaCont.startsWith('24');
              const debeNeg     = cuentaCont.startsWith('41') || cuentaCont.startsWith('28150501') || cuentaCont.startsWith('24');
              const montoCol11  = debeNeg ? -1 * monto : monto;              
              const montoCol11Str = String(Math.round(montoCol11));

              // Base fila 1: copia de la plantilla
              const base1 = TRANSAC_TEMPLATE_COLS.slice();

              // Regla 1.x
              base1[0]  = fecha6 || '';          // Col 1
              base1[1]  = fuente || '';          // Col 2
              base1[3]  = fechaYMD || '';        // Col 4
              base1[4]  = cuentaCont || '';      // Col 5
              base1[5]  = idCliente || '';       // Col 6
              base1[6]  = folio || '';           // Col 7
              base1[7]  = centroCosto || '';     // Col 8
              base1[9]  = nombreCargo || '';     // Col 10
              base1[10] = montoCol11Str;         // Col 11
              base1[16] = tipoFactura || '';     // Col 17
              base1[17] = numFactura || '';      // Col 18
              base1[18] = vencYMD || '';         // Col 19
    
              
              // Acumular para DOCUMENT
              const n1 = parseToNumber(base1[10]);
              if (n1 > 0) sumPos += n1;
              else if (n1 < 0) sumNeg += n1;

              const line1 = base1.join(';');
              lines.push(line1);

              // Fila 2: misma fila pero col 5 = cuenta_huespedes, col 11 invertida
              const base2 = base1.slice();
              base2[4] = cuentaHuesp || base1[4];

              const n2 = -1 * n1;
              const n2Rounded = Math.round(n2);
              base2[10] = String(n2Rounded);
              if (n2 > 0) sumPos += n2;
              else if (n2 < 0) sumNeg += n2;

              const line2 = base2.join(';');
              lines.push(line2);
            });

            if (!lines.length){
              if (status) status.textContent = 'No hay filas válidas para generar.';
              return;
            }

            // === 4) Timestamp compartido ===
            const now      = new Date();
            const iso      = now.toISOString();        // 2025-10-30T19:27:12.978Z
            const parts    = iso.split('T');
            const dPart    = parts[0];                 // 2025-10-30
            const tPartZ   = parts[1] || '';           // 19:27:12.978Z
            const tPart    = tPartZ.replace('Z','');   // 19:27:12.978
            const ts       = dPart + 'T' + tPart.replace(/:/g,''); // 2025-10-30T192712.978

            // === 5) Transac_Temp_Zeus ===
            const contentTransac = lines.join('\n') + '\n';
            {
              const blob = new Blob([contentTransac], { type:'text/plain;charset=utf-8' });
              const url  = URL.createObjectURL(blob);
              const a    = document.createElement('a');
              a.href = url;
              a.download = 'Transac_Temp_Zeus - ' + ts + '.txt';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }

            // === 6) Document_Temp_Zeus ===
            const totalRowsTransac = lines.length;
            const posRounded = Math.round(sumPos);
            const negRounded = Math.round(sumNeg);

            const firstFechaRaw    = (contabRows[0] && contabRows[0]['Fecha'] || '').toString().trim();
            const firstFechaDigits = firstFechaRaw.replace(/[^0-9]/g, '');
            const docCol1          = firstFechaDigits.slice(0, 6);
            const docCol4          = toDateYYYYMMDDSlash(firstFechaRaw);

            const docCols = [];
            docCols[0] = docCol1 || '';                  // Col 1
            docCols[1] = fuente || '';                   // Col 2
            docCols[2] = '00NUEVO';                      // Col 3
            docCols[3] = docCol4 || '';                  // Col 4
            docCols[4] = String(totalRowsTransac);       // Col 5
            docCols[5] = String(posRounded);             // Col 6
            docCols[6] = String(negRounded);             // Col 7
            docCols[7] = 'Contabilizacion Opera';        // Col 8
            docCols[8] = '123456789';                    // Col 9
            docCols[9] = fuente || '';                   // Col 10

            const docLine = docCols.join(';') + '\n';
            {
              const docBlob = new Blob([docLine], { type:'text/plain;charset=utf-8' });
              const url2    = URL.createObjectURL(docBlob);
              const a2      = document.createElement('a');
              a2.href = url2;
              a2.download = 'Document_Temp_Zeus - ' + ts + '.txt';
              document.body.appendChild(a2);
              a2.click();
              document.body.removeChild(a2);
              URL.revokeObjectURL(url2);
            }

            if (status) status.textContent = 'Archivos generados: Transac_Temp_Zeus y Document_Temp_Zeus.';
          } catch (e){
            console.error('Error generando archivos Zeus:', e);
            if (status) status.textContent = 'Error generando archivos: ' + e.message;
          }
        });
        genBtn._bound = true;
      }

      const genTerBtn = document.getElementById('contabGenerateTerceros');
      if (genTerBtn && !genTerBtn._bound){
        genTerBtn.addEventListener('click', () => {
          const st = document.getElementById('contabStatus');
          const rows = buildTercerosRows(contabRows);
          if (!rows.length){ if (st) st.textContent = 'No hay filas con Tipo_Documento_Cliente.'; return; }
          const content = rows.map(r => r.join(';')).join('\n');
          downloadText('Terceros_Zeus.txt', content);
          if (st) st.textContent = 'Generado Terceros_Zeus.txt ('+rows.length+' fila(s))';
        });
        genTerBtn._bound = true;
      }
      
    }

        // ======== INVENTARIO (Simphony MID) ========

      function parseInventoryMID(text){
      // Normaliza saltos de línea y filtra sólo líneas que empiezan por "MID|"
      const lines = text
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n")
        .split("\n")
        .map(l => l.trim())
        .filter(l => l && l.startsWith("MID|"));

      const rows = [];
      if (!lines.length) return rows;

      lines.forEach(line => {
        const parts = line.split("|");
        const obj = {};

        // Mapear en orden exacto al layout MID
        INV_MID_COLS.forEach((colName, idx) => {
          obj[colName] = parts[idx] ?? '';
        });

        rows.push(obj);
      });

      return rows;
    }

    // Normaliza la fecha del archivo Simphony para Zeus Inventario
    function normalizeZeusInvDate(raw){
      const digits = (raw || '').replace(/[^0-9]/g, '');
      if (digits.length >= 8){
        const y = digits.slice(0, 4);
        const m = digits.slice(4, 6);
        const d = digits.slice(6, 8);
        return {
          ymd: `${y}/${m}/${d}`,    // para columna 4
          stamp: `${y}${m}${d}`     // para nombre de archivo
        };
      }
      return {
        ymd: raw || '',
        stamp: digits || ''
      };
    }

    // Carga y cachea articulos_config desde Supabase, indexando por "Codigo de producto Simphony"
    async function ensureArticulosMapLoaded(){
      if (articulosMapBySimphony) return articulosMapBySimphony;
      try{
        const res = await loadArticulosFromSupabase();
        const rows = Array.isArray(res?.rows) ? res.rows : [];
        const map = {};
        rows.forEach(r => {
          const key = (r['Codigo de producto Simphony'] || '').toString().trim();
          if (!key) return;
          map[key] = r;
        });
        articulosMapBySimphony = map;
        return map;
      } catch (e){
        console.error('No se pudo cargar articulos_config desde Supabase:', e);
        articulosMapBySimphony = {};
        return articulosMapBySimphony;
      }
    }


    function renderInvTable(){
      const thead = document.getElementById('invHead');
      const tbody = document.getElementById('invBody');
      const pageInfo = document.getElementById('invPageInfo');
      if (!thead || !tbody) return;

      const rows = invMidFilteredRows.length ? invMidFilteredRows : invMidRows;
      const totalRows = rows.length;
      const totalPages = totalRows ? Math.ceil(totalRows / INV_PAGE_SIZE) : 1;
      if (invMidPage > totalPages) invMidPage = totalPages || 1;

      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (!rows.length || !INV_MID_COLS.length){
        thead.innerHTML = '<tr><th>Sin datos</th></tr>';
        if (pageInfo) pageInfo.textContent = '';
        return;
      }

      // Cabecera
      thead.innerHTML = '<tr>' + INV_MID_COLS.map(c => `<th>${c}</th>`).join('') + '</tr>';

      // Paginación
      const start = (invMidPage - 1) * INV_PAGE_SIZE;
      const end   = Math.min(start + INV_PAGE_SIZE, totalRows);

      const frag = document.createDocumentFragment();
      for (let i = start; i < end; i++){
        const row = rows[i];
        const tr = document.createElement('tr');
        INV_MID_COLS.forEach(col => {
          const td = document.createElement('td');
          td.textContent = row[col] ?? '';
          tr.appendChild(td);
        });
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);

      if (pageInfo){
        pageInfo.textContent = `Página ${invMidPage} de ${totalPages || 1} • ${totalRows} fila(s)`;
      }
    }

    function applyInvFilter(){
      const input = document.getElementById('invFilterInput');
      if (!input) return;
      const term = input.value.trim().toLowerCase();

      if (!term){
        invMidFilteredRows = [];
      } else {
        invMidFilteredRows = invMidRows.filter(row =>
          INV_MID_COLS.some(col => (row[col] ?? '').toString().toLowerCase().includes(term))
        );
      }
      invMidPage = 1;
      renderInvTable();
    }

    function initInventarioPage(){
      const fileInput   = document.getElementById('invFile');
      const dz          = document.getElementById('invDropZone');
      const status      = document.getElementById('invStatus');
      const filterInput = document.getElementById('invFilterInput');
      const prevBtn     = document.getElementById('invPrevPage');
      const nextBtn     = document.getElementById('invNextPage');
      const downloadBtn = document.getElementById('invDownloadCsv');
      const genZeusBtn  = document.getElementById('invGenerateZeus');

      async function handleFile(file){
        if (!file) return;
        try{
          const text = await file.text();

          // Obtener la 4ta posición de la primera fila del archivo original (no sólo MID)
          const rawLines = text
            .replace(/\r\n/g, "\n")
            .replace(/\r/g, "\n")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l !== '');

          if (rawLines.length){
            const firstParts = rawLines[0].split('|');
            zeusInvRawFileDate = (firstParts[3] || '').trim(); // 4a posición (índice 3)
          } else {
            zeusInvRawFileDate = '';
          }

          // Parsear sólo las líneas MID
          invMidRows = parseInventoryMID(text);
          invMidFilteredRows = [];
          invMidPage = 1;
          renderInvTable();
          if (status) status.textContent = 'Cargadas ' + invMidRows.length + ' fila(s) MID';
        } catch (err){
          console.error(err);
          if (status) status.textContent = 'Error leyendo archivo: ' + err.message;
        }
      }


      // Input file
      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files?.[0];
          handleFile(file);
        });
        fileInput._bound = true;
      }

      // Drag & drop
      if (dz && !dz._bound){
        dz.addEventListener('click', () => { fileInput?.click(); });
        dz.addEventListener('dragover', (ev) => {
          ev.preventDefault();
          dz.classList.add('dragover');
        });
        dz.addEventListener('dragleave', () => {
          dz.classList.remove('dragover');
        });
        dz.addEventListener('drop', (ev) => {
          ev.preventDefault();
          dz.classList.remove('dragover');
          const file = ev.dataTransfer?.files?.[0];
          handleFile(file);
        });
        dz._bound = true;
      }

      // Filtro de texto
      if (filterInput && !filterInput._bound){
        filterInput.addEventListener('input', () => {
          applyInvFilter();
        });
        filterInput._bound = true;
      }

      // Paginación
      if (prevBtn && !prevBtn._bound){
        prevBtn.addEventListener('click', () => {
          if (invMidPage > 1){
            invMidPage--;
            renderInvTable();
          }
        });
        prevBtn._bound = true;
      }

      if (nextBtn && !nextBtn._bound){
        nextBtn.addEventListener('click', () => {
          const rows = invMidFilteredRows.length ? invMidFilteredRows : invMidRows;
          const totalPages = rows.length ? Math.ceil(rows.length / INV_PAGE_SIZE) : 1;
          if (invMidPage < totalPages){
            invMidPage++;
            renderInvTable();
          }
        });
        nextBtn._bound = true;
      }

      // Descargar CSV
      if (downloadBtn && !downloadBtn._bound){
        downloadBtn.addEventListener('click', () => {
          const rows = invMidFilteredRows.length ? invMidFilteredRows : invMidRows;
          if (!rows.length){
            if (status) status.textContent = 'No hay filas para descargar.';
            return;
          }

          const sep = ';'; // CSV separado por punto y coma
          const headerLine = INV_MID_COLS.join(sep);
          const bodyLines = rows.map(row =>
            INV_MID_COLS.map(col => {
              let val = row[col] ?? '';
              val = val.toString();
              if (val.includes('"') || val.includes(sep) || val.includes('\n')){
                val = '"' + val.replace(/"/g, '""') + '"';
              }
              return val;
            }).join(sep)
          );
          const csv = headerLine + '\n' + bodyLines.join('\n');

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
          const url  = URL.createObjectURL(blob);
          const a    = document.createElement('a');
          const now  = new Date();
          const stamp = now.getFullYear().toString()
                       + pad2(now.getMonth()+1)
                       + pad2(now.getDate())
                       + '_' + pad2(now.getHours())
                       + pad2(now.getMinutes())
                       + pad2(now.getSeconds());
          a.href = url;
          a.download = 'Simphony_MID_' + stamp + '.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          if (status) status.textContent = 'CSV descargado (' + rows.length + ' fila(s)).';
        });
        downloadBtn._bound = true;
      }

            // Generar archivo "Movimiento Externo Simphony - Zeus Inventario_<filedate>.txt"
      if (genZeusBtn && !genZeusBtn._bound){
        genZeusBtn.addEventListener('click', async () => {
          const stEl = status;
          const rows = invMidFilteredRows.length ? invMidFilteredRows : invMidRows;

          if (!rows.length){
            if (stEl) stEl.textContent = 'No hay filas MID para generar archivo Zeus Inventario.';
            return;
          }

          if (!zeusInvRawFileDate){
            if (stEl) stEl.textContent = 'No se pudo determinar la fecha del archivo original (4ta columna).';
            return;
          }

          const { ymd, stamp } = normalizeZeusInvDate(zeusInvRawFileDate);
          const artMap = await ensureArticulosMapLoaded();

          const outLines = [];

    rows.forEach(row => {
      const menuItemNumber = (row['Menu Item Number'] || '').toString().trim();
      const menuItemName   = (row['Menu Item Name']   || '').toString().trim();
      const salesCount     = (row['Sales Count']      || '0').toString().trim();
      const salesTotal     = (row['Sales Total']      || '0').toString().trim();

      const artCfg = artMap[menuItemNumber] || {};
      const codArticuloZeus = (artCfg['Codigo de articulo Zeus'] || '').toString().trim();
      const codBodegaZeus   = (artCfg['Codigo Bodega Zeus']      || '').toString().trim();
      const centroCostoZeus = (artCfg['Centro de Costo Zeus']    || '').toString().trim();

      // ⬇️ NUEVO: usar la plantilla EXACTA del archivo ejemplo
      const base = ZEUS_INV_TEMPLATE_COLS.slice();

      // Asegurar que haya al menos 19 columnas
      while (base.length < 19) base.push('0');

      // Columnas específicas según tu lógica:
      // Col 4: fecha archivo en YYYY/MM/DD
      base[3] = ymd;

      // Col 5: "Simphony_<filedateStamp>_<Menu Item Name>"
      base[4] = `Simphony_${stamp}_${menuItemName}`;

      // Col 13: Codigo de articulo Zeus
      //base[12] = codArticuloZeus;
      base[9] = codArticuloZeus;

      // Col 14: Codigo Bodega Zeus
      //base[13] = codBodegaZeus;
      base[10] = codBodegaZeus;
      
      // Col 16: Sales Count
      base[15] = salesCount || '0';

      // Col 17: Centro de Costo Zeus
      base[16] = centroCostoZeus;

      // Col 19: Sales Total
      base[18] = salesTotal || '0';

      outLines.push(base.join(','));
    });


          if (!outLines.length){
            if (stEl) stEl.textContent = 'No se generaron filas para el archivo Zeus Inventario.';
            return;
          }

          const fileDateStamp = normalizeZeusInvDate(zeusInvRawFileDate).stamp || '00000000';
          const filename = `Movimiento Externo Simphony - Zeus Inventario_${fileDateStamp}.txt`;
          const content  = outLines.join('\n');

          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const url  = URL.createObjectURL(blob);
          const a    = document.createElement('a');
          a.href     = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          if (stEl) stEl.textContent = `Archivo ${filename} generado (${outLines.length} fila(s)).`;
        });
        genZeusBtn._bound = true;
      }

    }

    

    // ======== UTILIDADES GENERALES ========
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function formatTimestamp(iso){
      if (!iso) return '(sin publicar)';
      const d = new Date(iso); if (isNaN(d.getTime())) return iso;
      const yyyy = d.getUTCFullYear(); const mm = pad2(d.getUTCMonth()+1); const dd = pad2(d.getUTCDate());
      const hh = pad2(d.getUTCHours()); const mi = pad2(d.getUTCMinutes());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi} UTC`;
    }

    // === Helpers para descarga y normalización (Terceros Zeus) ===
function downloadText(filename, content){
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}

    
function normalizeStr(s){
  return (s||'').toString().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
}

// ======== TERCEROS (helpers y generador de filas) ========
// Normaliza nombres de país (quita acentos, colapsa espacios, a minúsculas)
function normalizeStrForCountry(s){
  return (s||'').toString().trim().normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,' ');
}

// ISO 3166-1 alpha-2 (en / es comunes). Si ya viene en 2 letras, respeta.
function toISO2Country(name){
  if (!name) return '';
  const raw = name.toString().trim();
  if (/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();
  const key = normalizeStrForCountry(raw);
  const m = {"afghanistan":"AF","albania":"AL","algeria":"DZ","andorra":"AD","angola":"AO","antigua and barbuda":"AG",
"argentina":"AR","armenia":"AM","australia":"AU","austria":"AT","azerbaijan":"AZ","bahamas":"BS","bahrain":"BH","bangladesh":"BD","barbados":"BB","belarus":"BY","belgium":"BE","belize":"BZ",
"benin":"BJ","bhutan":"BT","bolivia":"BO","bosnia and herzegovina":"BA","botswana":"BW","brazil":"BR","brunei":"BN","bulgaria":"BG","burkina faso":"BF","burundi":"BI","cabo verde":"CV","cambodia":"KH","cameroon":"CM",
"canada":"CA","central african republic":"CF","chad":"TD","chile":"CL","china":"CN","colombia":"CO","comoros":"KM","congo":"CG","costa rica":"CR","croatia":"HR","cuba":"CU","cyprus":"CY","czech republic":"CZ","czechia":"CZ",
"denmark":"DK","djibouti":"DJ","dominica":"DM","dominican republic":"DO","republica dominicana":"DO","república dominicana":"DO","ecuador":"EC","egypt":"EG","el salvador":"SV","equatorial guinea":"GQ","eritrea":"ER","estonia":"EE",
"eswatini":"SZ","ethiopia":"ET","fiji":"FJ","finland":"FI","france":"FR","gabon":"GA","gambia":"GM","georgia":"GE","germany":"DE","ghana":"GH","greece":"GR","grenada":"GD","guatemala":"GT","guinea":"GN","guinea-bissau":"GW","guyana":"GY",
"haiti":"HT","honduras":"HN","hungary":"HU","iceland":"IS","india":"IN","indonesia":"ID","iran":"IR","iraq":"IQ","ireland":"IE","israel":"IL","italy":"IT","jamaica":"JM","japan":"JP","japon":"JP","japón":"JP","jordan":"JO",
"kazakhstan":"KZ","kenya":"KE","kiribati":"KI","kosovo":"XK","kuwait":"KW","kyrgyzstan":"KG","laos":"LA","latvia":"LV","lebanon":"LB","lesotho":"LS","liberia":"LR","libya":"LY","liechtenstein":"LI","lithuania":"LT","luxembourg":"LU",
"madagascar":"MG","malawi":"MW","malaysia":"MY","maldives":"MV","mali":"ML","malta":"MT","marshall islands":"MH","mauritania":"MR","mauritius":"MU","mexico":"MX","méxico":"MX","micronesia":"FM","moldova":"MD","monaco":"MC","mongolia":"MN","montenegro":"ME","morocco":"MA","mozambique":"MZ",
"myanmar":"MM","namibia":"NA","nauru":"NR","nepal":"NP","netherlands":"NL","new zealand":"NZ","nicaragua":"NI","niger":"NE","nigeria":"NG","north korea":"KP","north macedonia":"MK","norway":"NO",
"oman":"OM","pakistan":"PK","palau":"PW","panama":"PA","panamá":"PA","papua new guinea":"PG","paraguay":"PY","peru":"PE","perú":"PE","philippines":"PH","poland":"PL","portugal":"PT","qatar":"QA","romania":"RO","russia":"RU","russian federation":"RU","rwanda":"RW",
"saint kitts and nevis":"KN","saint lucia":"LC","saint vincent and the grenadines":"VC","samoa":"WS","san marino":"SM","sao tome and principe":"ST","saudi arabia":"SA","senegal":"SN","serbia":"RS","seychelles":"SC","sierra leone":"SL","singapore":"SG","slovakia":"SK","slovenia":"SI","solomon islands":"SB","somalia":"SO","south africa":"ZA","south korea":"KR","korea":"KR","south sudan":"SS","spain":"ES","españa":"ES","sri lanka":"LK","sudan":"SD","suriname":"SR","sweden":"SE","switzerland":"CH","syria":"SY",
"taiwan":"TW","tajikistan":"TJ","tanzania":"TZ","thailand":"TH","timor-leste":"TL","togo":"TG","tonga":"TO","trinidad and tobago":"TT","tunisia":"TN","turkey":"TR","turkiye":"TR","turkmenistan":"TM","tuvalu":"TV",
"uganda":"UG","ukraine":"UA","united arab emirates":"AE","uae":"AE","united kingdom":"GB","reino unido":"GB","uk":"GB","united states":"US","estados unidos":"US","usa":"US","uruguay":"UY","uzbekistan":"UZ",
"vanuatu":"VU","vatican city":"VA","venezuela":"VE","vietnam":"VN","yemen":"YE","zambia":"ZM","zimbabwe":"ZW"};
  return m[key] || '';
}

// Limpia ; y trim
function safeField(v){ return (v||'').toString().trim().replace(/;/g,' '); }

// ✅ Construye filas para Terceros_Zeus.txt **sin duplicados**
//   - Filtra filas con Tipo_Documento_Cliente no vacío
//   - Duplicado = mismo (ID_Cliente, Nombre_Cliente) tras trim/lower
function buildTercerosRows(rows){
  const filtered = (rows||[]).filter(r => (r['Tipo_Documento_Cliente']||'').toString().trim() !== '');
  const seen = new Set();
  const out = [];
  for (const r of filtered){
    const id = safeField(r['ID_Cliente']);
    const name = safeField(r['Nombre_Cliente']);
    if (!id || !name) continue; // ignora filas sin clave
    const key = id + '||' + name.toLowerCase();
   // if (seen.has(key)) continue; // 🔁 elimina duplicados
    //seen.add(key);

    const tipoDoc = (r['Tipo_Documento_Cliente']||'').toString().trim();
    const direccion = safeField(r['Direccion_Cliente']);
    const ciudad = safeField(r['Ciudad_Cliente']);
    const tel = safeField(r['Telefono_Cliente']);
    const pais = safeField(r['Pais_Cliente']);

    const jn = (tipoDoc === '11') ? 'J' : 'N';
    let docType = '';
    if (tipoDoc === '13') docType = 'CC';
    else if (tipoDoc === '41') docType = 'PAP';
    else if (tipoDoc === '11') docType = 'NIT';

    const iso = toISO2Country(pais);

    const row = [
      id,            // 1  ID_Cliente
      name,          // 2  Nombre_Cliente
      '',            // 3  empty
      jn,            // 4  J / N
      'OTROS',       // 5  literal
      '48',          // 6  literal 48
      direccion,     // 7  Direccion_Cliente
      ciudad,        // 8  Ciudad_Cliente
      '',            // 9  empty
      '',            // 10 empty
      tel,           // 11 Telefono_Cliente
      docType,       // 12 tipo doc mapeado
      '', '', '', '',// 13-16 empties
      name,          // 17 Nombre_Cliente
      '', '', '', '', '', '', '', '', '', // 18-26 empties
      iso,           // 27 ISO2 país
      'N'            // 28 literal
    ].map(s => (s||'').toString().trim());

    out.push(row);
  }
  return out;
}


    
    // ======== PARSER XML (Ventas) ========
    const parseText = (node, sel) => (node.querySelector(sel)?.textContent ?? '').trim();
    const parseAttr = (node, name, fallback='') => (node.getAttribute(name) ?? fallback);

    function buildBillsRows(xml){
      const bills = Array.from(xml.querySelectorAll('bill'));
      return bills.map(bill => {
        const resInfo = bill.querySelector('reservation_info');
        const extInfo = bill.querySelector('external_fiscal_info');
        return {
          customer_internal_id: parseAttr(bill, 'customer_internal_id'),
          bill_no: parseText(bill, 'bill_no'),
          bill_type: parseText(bill, 'bill_type'),
          status: parseText(bill, 'status'),
          total_amount: parseText(bill, 'total_amount'),
          name_tax_type: parseText(bill, 'name_tax_type'),
          invoice_no: parseText(bill, 'invoice_no'),
          guest_internal_id: parseText(bill, 'guest_internal_id'),
          confirmation_no: resInfo ? parseText(resInfo, 'confirmation_no') : '',
          arrival_date: resInfo ? parseText(resInfo, 'arrival_date') : '',
          departure_date: resInfo ? parseText(resInfo, 'departure_date') : '',
          guest_name: resInfo ? parseText(resInfo, 'guest_name') : '',
          fiscal_bill_no: extInfo ? parseText(extInfo, 'fiscal_bill_no') : ''
        };
      });
    }

    function buildTransactionsRows(xml){
      const rows = [];
      xml.querySelectorAll('bill').forEach(bill => {
        const billNo = parseText(bill, 'bill_no');
        const guest = bill.querySelector('reservation_info > guest_name')?.textContent?.trim() || '';
        bill.querySelectorAll('bill_detail > transaction').forEach(trx => {
          rows.push({
            bill_no: billNo,
            guest_name: guest,
            trx_no: parseAttr(trx, 'trx_no'),
            trx_no_added_by: parseAttr(trx, 'trx_no_added_by', ''),
            trx_code: parseText(trx, 'trx_code'),
            trx_date: parseText(trx, 'trx_date'),
            cheque_number: parseText(trx, 'cheque_number'),
            net_amount: parseText(trx, 'net_amount'),
            debit_amount: parseText(trx, 'debit_amount'),
            credit_amount: parseText(trx, 'credit_amount'),
            foreign_currency: parseText(trx, 'foreign_currency'),
            foreign_amount: parseText(trx, 'foreign_amount')
          });
        });
      });
      return rows;
    }

    function renderTable(tableEl, rows){
      const thead = tableEl.querySelector('thead');
      const tbody = tableEl.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      if (!rows || !rows.length) { thead.innerHTML = '<tr><th>Sin datos</th></tr>'; return; }
      const cols = Object.keys(rows[0]);
      thead.innerHTML = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        cols.forEach(c => { const td = document.createElement('td'); td.textContent = r[c] ?? ''; tr.appendChild(td); });
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    function initVentasPage(){
      // Pestañas (Facturas / Transacciones)
      document.querySelectorAll('#ventas .tab').forEach(tab => tab.addEventListener('click', () => {
        document.querySelectorAll('#ventas .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-target');
        ['#billsTableWrap','#trxTableWrap'].forEach(id => {
          const el = document.querySelector(id); if (!el) return; el.style.display = (id === target) ? 'block' : 'none';
        });
      }));

      // File input XML Opera
      const fileInput = document.getElementById('xmlFile');
      if (fileInput && !fileInput._bound){
        fileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          const status = document.getElementById('ventasStatus');
          if (!file) return;
          try {
            const text = await file.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'application/xml');
            const err = xml.querySelector('parsererror');
            if (err) throw new Error('XML inválido');
            const billRows = buildBillsRows(xml);
            const trxRows  = buildTransactionsRows(xml);
            renderTable(document.getElementById('billsTable'), billRows);
            renderTable(document.getElementById('trxTable'),  trxRows);
            if (status) status.textContent = `Cargadas ${billRows.length} factura(s) y ${trxRows.length} transacción(es)`;
          } catch (ex){ if (status) status.textContent = 'Error: ' + ex.message; }
        });
        fileInput._bound = true;
      }
    }

    // ======== NAV / EVENTOS ========
    const menuItems = document.querySelectorAll('.menu-item');

    function showSection(id){
      document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden')); // Oculta todo
      const el = document.getElementById(id); if (el) el.classList.remove('hidden');    // Muestra
      if (id === 'configgeneral')  { initGeneralPage(); loadGeneralConfig(); }
      if (id === 'cuentas')          loadCuentasConfig();
      if (id === 'articulos')        loadArticulosConfig();
      if (id === 'ventas')           initVentasPage();
      if (id === 'contabilizacion')  initContabilizacionPage();
      if (id === 'inventario')       initInventarioPage();
    }

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        menuItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const target = item.getAttribute('data-section');
        showSection(target);
      });
    });

    // Botones cuentas contables
    document.getElementById('cuentasSave')?.addEventListener('click', saveCuentasConfig);
    document.getElementById('cuentasAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#cuentasTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      CUENTAS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // Botones artículos
    document.getElementById('articulosSave')?.addEventListener('click', saveArticulosConfig);
    document.getElementById('articulosAddRow')?.addEventListener('click', () => {
      const tbody = document.querySelector('#articulosTable tbody'); if (!tbody) return;
      const tr = document.createElement('tr');
      ARTICULOS_COLS.forEach(() => { const td = document.createElement('td'); td.contentEditable = 'true'; tr.appendChild(td); });
      tbody.appendChild(tr);
    });

    // ======== INICIALIZACIÓN POR DEFECTO ========
    // Open "Contabilización" by default
    showSection('contabilizacion');
    document.querySelector('.menu-item[data-section="contabilizacion"]')?.classList.add('active');


    // ======== TESTS ========
    (function runSmokeTests(){
      try {
        // Estructura básica esperada
        console.assert(Array.isArray(CUENTAS_COLS) && CUENTAS_COLS.length === 10, 'CUENTAS_COLS debe tener 10 columnas');
        console.assert(Array.isArray(ARTICULOS_COLS) && ARTICULOS_COLS.length === 5,  'ARTICULOS_COLS debe tener 5 columnas');
        console.assert(Array.isArray(CONTAB_COLS)  && CONTAB_COLS.length === 23, 'CONTAB_COLS debe tener 23 columnas');

        // Test de persistencia local para Artículos
        const keyTest = ARTICULOS_KEY + '_test';
        const sample = [{
          'Codigo de producto Simphony': 'P001',
          'Nombre de producto Simphony': 'Producto Demo',
          'Codigo de articulo Zeus': 'Z-100',
          'Centro de Costo Zeus': 'CC01',
          'Codigo Bodega Zeus': 'B01'
        }];
        localStorage.setItem(keyTest, JSON.stringify(sample));
        const got = JSON.parse(localStorage.getItem(keyTest) || '[]');
        console.assert(got.length === 1 && got[0]['Codigo de articulo Zeus'] === 'Z-100', 'Persistencia básica localStorage (artículos)');
        localStorage.removeItem(keyTest);

        // Tests adicionales para parseTSV (LF / CRLF / CR) y mapeo de columnas
        const tsv1 = '2025-11-01\tC001\n2025-11-02\tC002\n';
        const res1 = parseTSV(tsv1);
        console.assert(res1.length === 2, 'parseTSV debe leer 2 filas (LF)');
        console.assert(res1[0]['Fecha'] === '2025-11-01' && res1[0]['Codigo_Cargo_Opera'] === 'C001', 'parseTSV mapea columnas (LF)');

        const tsv2 = '2025-11-03\tC010\r\n2025-11-04\tC020\r\n';
        const res2 = parseTSV(tsv2);
        console.assert(res2.length === 2, 'parseTSV debe leer 2 filas (CRLF)');
        console.assert(res2[1]['Fecha'] === '2025-11-04' && res2[1]['Codigo_Cargo_Opera'] === 'C020', 'parseTSV mapea columnas (CRLF)');

        const tsv3 = '2025-11-05\tC100\r2025-11-06\tC200\r';
        const res3 = parseTSV(tsv3);
        console.assert(res3.length === 2, 'parseTSV debe leer 2 filas (CR)');
        console.assert(res3[0]['Fecha'] === '2025-11-05' && res3[0]['Codigo_Cargo_Opera'] === 'C100', 'parseTSV mapea columnas (CR)');

        // Test Col_O insertado entre Col_N y Factura
        const tsv4 = '2025-12-01\tC777\tCargo X\t1500\tJuan Perez\tID777\t3000000000\tCalle 123\tjuan@x.com\tBogotá\tCO\tMVAL\tNVAL\tOVAL\tF001\tPVAL\tQVAL\tCC\tFAC\t2025-12-10\tUVAL\tFOLIOX\tWVAL\n';
        const res4 = parseTSV(tsv4);
        console.assert(res4.length === 1, 'parseTSV debe leer 1 fila (Col_O)');
        console.assert(res4[0]['Col_O'] === 'OVAL' && res4[0]['Factura'] === 'F001', 'Col_O correctamente mapeada y en orden');

        // Tests de UI básicos
        console.assert(document.getElementById('cuentasTable') instanceof HTMLTableElement, 'Tabla de cuentas existe');
        console.assert(document.getElementById('contabTable') instanceof HTMLTableElement, 'Tabla de contabilización existe');

        console.assert(typeof initSupabaseIfNeeded === 'function', 'initSupabaseIfNeeded debe existir');
        console.assert(typeof saveCuentasToSupabase === 'function', 'saveCuentasToSupabase debe existir');
        console.assert(typeof loadCuentasFromSupabase === 'function', 'loadCuentasFromSupabase debe existir');

        // Nuevos helpers de artículos
        console.assert(typeof saveArticulosToSupabase === 'function', 'saveArticulosToSupabase debe existir');
        console.assert(typeof loadArticulosFromSupabase === 'function', 'loadArticulosFromSupabase debe existir');

        console.assert(typeof saveGeneralToSupabase === 'function', 'saveGeneralToSupabase debe existir');
        console.assert(typeof loadGeneralFromSupabase === 'function', 'loadGeneralFromSupabase debe existir');
        console.assert(sanitizeDigits('A1B2C3') === '123', 'sanitizeDigits');
        console.assert(sanitizeAlnum('A-1_B 2!') === 'A1B2', 'sanitizeAlnum');

        console.assert(document.getElementById('inpFuente') instanceof HTMLInputElement, 'Campo Fuente existe');

        // Inventario MID – smoke test
        const midSample = 'MID|1|10|20|1001|Burger|1|3|30|0|0|0|Burger Master|1001|RC1|RCM1|1|Burger 2';
        const midParsed = parseInventoryMID(midSample);
        console.assert(midParsed.length === 1, 'parseInventoryMID debe devolver 1 fila');
        console.assert(midParsed[0]['Record Type'] === 'MID', 'parseInventoryMID Record Type');
        console.assert(midParsed[0]['Menu Item Name'] === 'Burger', 'parseInventoryMID Menu Item Name');

        
        // Extra: smoke test de invocación segura (no debe lanzar)
        (async ()=>{ try { const r = await saveArticulosConfig(); console.assert(r === false, 'saveArticulosConfig vacío debe retornar false y no upsert'); } catch (e) { console.error('saveArticulosConfig lanzó excepción inesperada', e); } })();

        console.log('%cSmoke tests OK','color:#22c55e');
      } catch (e) { console.error('Smoke tests FAILED', e); }
    })();
  }); // FIN DOMContentLoaded
  </script>
</body>
</html>
